{% extends "base.html" %}
{% load static %}

{% block title %}Registered Vehicles | RDFS{% endblock %}

{% block content %}

<style>
/* =====================================================
   RDFS – REGISTERED VEHICLES (CARD VIEW)
===================================================== */
.rdfs-vehicles-scope{
  --rdfs-blue:#112666;
  --rdfs-blue-dark:#0c1c4a;
  --rdfs-accent:#2563eb;
  --rdfs-soft:#e8f4fd;

  --rdfs-text:#0f172a;
  --rdfs-muted:#64748b;

  --gray-100:#f7fafc;
  --gray-200:#edf2f7;
  --gray-300:#e2e8f0;

  --shadow-sm:0 2px 6px rgba(0,0,0,.08);
  --shadow-md:0 10px 24px rgba(0,0,0,.14);

  font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
  color:var(--rdfs-text);
}

/* HEADER */
.rdfs-vehicles-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:1rem;
  margin-bottom:1.5rem;
}

.rdfs-vehicles-title{
  font-weight:800;
  color:var(--rdfs-blue-dark);
}

.rdfs-vehicles-subtitle{
  font-size:.9rem;
  color:var(--rdfs-muted);
}

/* SEARCH */
.rdfs-vehicles-search{
  position:relative;
  max-width:420px;
}

.rdfs-vehicles-search input{
  width:100%;
  height:46px;
  padding:0 90px 0 44px;
  border-radius:999px;
  border:1.5px solid var(--gray-300);
  background:var(--gray-100);
}

.rdfs-vehicles-search-icon{
  position:absolute;
  left:16px;
  top:50%;
  transform:translateY(-50%);
  color:var(--rdfs-muted);
}

.rdfs-vehicles-search button{
  position:absolute;
  right:6px;
  top:50%;
  transform:translateY(-50%);
  height:34px;
  padding:0 18px;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,var(--rdfs-accent),var(--rdfs-blue));
  color:#fff;
  font-weight:700;
  font-size:.8rem;
}

/* GRID */
.rdfs-vehicle-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:1.25rem;
}

/* CARD */
.rdfs-vehicle-card{
  background:#fff;
  border-radius:18px;
  box-shadow:var(--shadow-md);
  border:1px solid var(--gray-200);
  display:flex;
  flex-direction:column;
  height:100%;
}

.rdfs-vehicle-card-header{
  padding:1rem 1.25rem;
  border-bottom:1px solid var(--gray-200);
}

.rdfs-vehicle-name{
  font-weight:800;
  margin-bottom:.25rem;
}

.rdfs-vehicle-meta{
  font-size:.85rem;
  color:var(--rdfs-muted);
}

/* BODY */
.rdfs-vehicle-card-body{
  padding:1rem 1.25rem;
  display:grid;
  grid-template-columns:1fr 120px;
  gap:1rem;
}

.rdfs-vehicle-info p{
  margin-bottom:.35rem;
  font-size:.9rem;
}

.rdfs-vehicle-info span{
  color:var(--rdfs-muted);
}

/* QR */
.rdfs-vehicle-qr{
  text-align:center;
}

.rdfs-vehicle-qr img{
  max-width:100%;
  border-radius:10px;
  border:1px solid var(--gray-300);
}

/* FOOTER */
.rdfs-vehicle-card-footer{
  padding:.75rem 1.25rem;
  border-top:1px solid var(--gray-200);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:.5rem;
}
</style>

<div class="rdfs-vehicles-scope p-4">

  <!-- HEADER -->
  <div class="rdfs-vehicles-header">
    <div>
      <h3 class="rdfs-vehicles-title">
        <i class="bi bi-truck-front-fill me-2"></i>
        Registered Vehicles
      </h3>
      <p class="rdfs-vehicles-subtitle">
        Browse registered vehicles and scan-ready QR codes.
      </p>
    </div>

    <a href="{% url 'accounts:staff_dashboard' %}"
       class="btn btn-outline-primary rounded-pill">
      <i class="bi bi-arrow-left-circle me-1"></i> Dashboard
    </a>
  </div>

  <!-- SEARCH -->
  <div class="mb-4">
    <div class="rdfs-vehicles-search">
      <i class="bi bi-search rdfs-vehicles-search-icon"></i>
      <input type="text" id="rdfsVehicleSearch" placeholder="Search vehicle, driver, plate…">
      <button type="button">Search</button>
    </div>
  </div>

  <!-- CARDS -->
  {% if vehicles %}
  <div class="rdfs-vehicle-grid" id="rdfsVehicleGrid">

    {% for vehicle in vehicles %}
    <div class="rdfs-vehicle-card" data-search="{{ vehicle.vehicle_name }} {{ vehicle.license_plate }} {{ vehicle.assigned_driver.first_name }} {{ vehicle.assigned_driver.last_name }}">

      <!-- HEADER -->
      <div class="rdfs-vehicle-card-header">
        <div class="rdfs-vehicle-name">
          {{ vehicle.vehicle_name }}
        </div>
        <div class="rdfs-vehicle-meta">
          {{ vehicle.get_vehicle_type_display }} • {{ vehicle.license_plate }}
        </div>
      </div>

      <!-- BODY -->
      <div class="rdfs-vehicle-card-body">

        <div class="rdfs-vehicle-info">
          <p><strong>Driver:</strong>
            {% if vehicle.assigned_driver %}
              {{ vehicle.assigned_driver.first_name }} {{ vehicle.assigned_driver.last_name }}
            {% else %}
              <span>Unassigned</span>
            {% endif %}
          </p>
          <p><strong>VIN:</strong> {{ vehicle.vin_number }}</p>
          <p><strong>Year:</strong> {{ vehicle.year_model }}</p>
          <p><strong>CR / OR:</strong><br>
            <span>{{ vehicle.cr_number }}</span><br>
            <span>{{ vehicle.or_number }}</span>
          </p>
        </div>

        <div class="rdfs-vehicle-qr">
          {% if vehicle.qr_code %}
            <img src="{{ vehicle.qr_code.url }}" alt="QR Code">
            <div class="mt-2">
              <a href="{% url 'vehicles:vehicle_qr' vehicle.id %}"
                 target="_blank"
                 class="btn btn-sm btn-outline-secondary rounded-pill">
                <i class="bi bi-printer-fill me-1"></i> Print
              </a>
            </div>
          {% else %}
            <span class="text-muted">No QR</span>
          {% endif %}
        </div>

      </div>

      <!-- FOOTER -->
      <div class="rdfs-vehicle-card-footer">
        <small class="text-muted">
          Registered {{ vehicle.date_registered|date:"M d, Y" }}
        </small>

        {% if user.is_superuser or user.role == 'admin' %}
        <button class="btn btn-sm btn-danger btn-delete-item"
                data-url="{% url 'vehicles:delete_vehicle' vehicle.id %}"
                data-type="Vehicle">
          <i class="bi bi-trash-fill me-1"></i> Delete
        </button>
        {% endif %}
      </div>

    </div>
    {% endfor %}

  </div>
  {% else %}
    <p class="text-center text-muted">No vehicles registered yet.</p>
  {% endif %}

</div>

<script>
document.addEventListener("DOMContentLoaded",function(){

  /* SEARCH FILTER */
  const searchInput=document.getElementById("rdfsVehicleSearch");
  searchInput.addEventListener("keyup",function(){
    const value=this.value.toLowerCase();
    document.querySelectorAll(".rdfs-vehicle-card").forEach(card=>{
      card.style.display = card.dataset.search.toLowerCase().includes(value)
        ? "flex"
        : "none";
    });
  });

  /* DELETE */
  document.querySelectorAll('.btn-delete-item').forEach(btn=>{
    btn.addEventListener('click',function(){
      const url=this.dataset.url;
      const type=this.dataset.type;
      if(confirm(`Delete this ${type}?`)){
        fetch(url,{
          method:'POST',
          headers:{'X-CSRFToken':'{{ csrf_token }}'}
        }).then(()=>location.reload());
      }
    });
  });

});
</script>

{% endblock %}
