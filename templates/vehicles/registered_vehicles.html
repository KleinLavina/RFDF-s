{% extends "base.html" %}
{% load static %}

{% block title %}Registered Vehicles | RDFS{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'styles/vehicles/02.css' %}">

<div class="rdfs-vehicles-scope p-4">

  <!-- HEADER -->
  <div class="rdfs-vehicles-header">
    <div>
      <h3 class="rdfs-vehicles-title mb-1">
        <i class="fas fa-truck me-2"></i>
        Registered Vehicles
      </h3>
      <p class="rdfs-vehicles-subtitle mb-0">
        Browse registered vehicles and scan-ready QR codes. 16 vehicles per page.
      </p>
    </div>

    <a href="{% url 'accounts:staff_dashboard' %}" class="rdfs-vehicles-back">
      <i class="fas fa-arrow-left-circle me-1"></i>
      Return to Dashboard
    </a>
  </div>


  <!-- SEARCH -->
  <div class="mb-4">
    <div class="rdfs-vehicles-search">
      <i class="fas fa-search rdfs-vehicles-search-icon"></i>
      <input type="text"
             id="rdfsVehicleSearch"
             placeholder="Search vehicle, driver, plate, VIN…">
      <button type="button">Search</button>
    </div>
  </div>

  <!-- RESULTS COUNTER -->
  {% if page_obj %}
  <div class="rdfs-results-counter">
    <i class="fas fa-filter"></i>
    Showing <strong>{{ page_obj.start_index }} - {{ page_obj.end_index }}</strong> 
    of <strong>{{ page_obj.paginator.count }}</strong> vehicle{{ page_obj.paginator.count|pluralize }}
  </div>
  {% endif %}

  <!-- VEHICLE CARDS -->
  <div class="rdfs-vehicle-grid" id="rdfsVehicleGrid">

    {% for vehicle in page_obj %}
    <div class="rdfs-vehicle-card"
         data-search="{{ vehicle.vehicle_name }} {{ vehicle.license_plate }} {{ vehicle.vin_number }} {{ vehicle.assigned_driver.first_name|default:'' }} {{ vehicle.assigned_driver.last_name|default:'' }}">

      <!-- HEADER -->
      <div class="rdfs-vehicle-card-header">
        <div class="rdfs-vehicle-name">
          {{ vehicle.vehicle_name }}
        </div>
        <div class="rdfs-vehicle-meta">
          <i class="fas fa-car me-1"></i> {{ vehicle.get_vehicle_type_display }} • 
          <i class="fas fa-plate me-1"></i> {{ vehicle.license_plate }}
        </div>
      </div>

      <!-- BODY -->
      <div class="rdfs-vehicle-card-body">
        
        <!-- DRIVER SECTION WITH PFP -->
        <div class="rdfs-driver-section">
          <div class="rdfs-driver-pfp">
            {% if vehicle.assigned_driver and vehicle.assigned_driver.driver_photo %}
              <img src="{{ vehicle.assigned_driver.driver_photo.url }}" 
                   alt="{{ vehicle.assigned_driver.first_name }}"
                   class="rdfs-driver-pfp">
            {% else %}
              <i class="fas fa-user"></i>
            {% endif %}
          </div>
          
          <div class="rdfs-driver-info">
            <div class="rdfs-driver-name">
              {% if vehicle.assigned_driver %}
                <i class="fas fa-id-card me-1"></i>
                {{ vehicle.assigned_driver.first_name }} {{ vehicle.assigned_driver.last_name }}
              {% else %}
                <span class="text-muted">No driver assigned</span>
              {% endif %}
            </div>
            {% if vehicle.assigned_driver %}
            <div class="rdfs-driver-id">
              ID: {{ vehicle.assigned_driver.driver_id|default:"N/A" }}
            </div>
            {% endif %}
          </div>
        </div>

        <!-- VEHICLE DETAILS & QR -->
        <div class="rdfs-vehicle-info-grid">
          <div class="rdfs-vehicle-details">
            <div class="rdfs-detail-item">
              <span class="rdfs-detail-label">VIN Number</span>
              <span class="rdfs-detail-value">{{ vehicle.vin_number }}</span>
            </div>
            
            <div class="rdfs-detail-item">
              <span class="rdfs-detail-label">Year Model</span>
              <span class="rdfs-detail-value">{{ vehicle.year_model }}</span>
            </div>
            
            <div class="rdfs-detail-item">
              <span class="rdfs-detail-label">CR Number</span>
              <span class="rdfs-detail-value">{{ vehicle.cr_number|default:"N/A" }}</span>
            </div>
            
            <div class="rdfs-detail-item">
              <span class="rdfs-detail-label">OR Number</span>
              <span class="rdfs-detail-value">{{ vehicle.or_number|default:"N/A" }}</span>
            </div>
          </div>

          <div class="rdfs-vehicle-qr">
            {% if vehicle.qr_code %}
              <img src="{{ vehicle.qr_code.url }}" alt="QR Code">
              <div class="mt-2">
                <a href="{% url 'vehicles:vehicle_qr' vehicle.id %}"
                   target="_blank"
                   class="btn btn-sm btn-outline-primary rounded-pill">
                  <i class="fas fa-print me-1"></i> Print
                </a>
              </div>
            {% else %}
              <div class="text-muted">
                <i class="fas fa-qrcode fa-2x mb-2"></i>
                <div class="small">No QR Generated</div>
              </div>
            {% endif %}
          </div>
        </div>

      </div>

      <!-- FOOTER -->
      <div class="rdfs-vehicle-card-footer">
        <div class="text-muted small">
          <i class="fas fa-calendar-alt me-1"></i>
          Registered {{ vehicle.date_registered|date:"M d, Y" }}
        </div>

  <button type="button"
          class="btn btn-sm btn-outline-primary btn-edit-vehicle me-2"
          data-edit-url="{% url 'vehicles:vehicle_edit_form' vehicle.id %}">
    <i class="fas fa-pen me-1"></i> Edit
  </button>
        {% if user.is_superuser or user.role == 'admin' %}
  <button class="btn-delete-vehicle btn-delete-item"
        data-url="{% url 'vehicles:delete_vehicle' vehicle.id %}"
        data-type="Vehicle"
        data-name="{{ vehicle.vehicle_name }}">
  <i class="fas fa-trash"></i> Delete
</button>
        {% endif %}
      </div>

    </div>
    {% empty %}
    <div class="rdfs-empty-state">
      <i class="fas fa-truck-loading"></i>
      <p class="mb-0">No vehicles registered yet.</p>
      <p class="mt-2 small">Register your first vehicle to get started.</p>
    </div>
    {% endfor %}

  </div>

  <!-- PAGINATION -->
  {% if page_obj.has_other_pages %}
  <div class="rdfs-pagination-container">
    <ul class="rdfs-pagination">
      {% if page_obj.has_previous %}
        <li class="rdfs-pagination-item">
          <a class="rdfs-pagination-link rdfs-pagination-arrow" 
             href="?page={{ page_obj.previous_page_number }}">
            <i class="fas fa-chevron-left"></i> Previous
          </a>
        </li>
      {% else %}
        <li class="rdfs-pagination-item">
          <span class="rdfs-pagination-link rdfs-pagination-arrow disabled">
            <i class="fas fa-chevron-left"></i> Previous
          </span>
        </li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
          <li class="rdfs-pagination-item">
            <span class="rdfs-pagination-link active">{{ num }}</span>
          </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="rdfs-pagination-item">
            <a class="rdfs-pagination-link" 
               href="?page={{ num }}">
              {{ num }}
            </a>
          </li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="rdfs-pagination-item">
          <a class="rdfs-pagination-link rdfs-pagination-arrow" 
             href="?page={{ page_obj.next_page_number }}">
            Next <i class="fas fa-chevron-right"></i>
          </a>
        </li>
      {% else %}
        <li class="rdfs-pagination-item">
          <span class="rdfs-pagination-link rdfs-pagination-arrow disabled">
            Next <i class="fas fa-chevron-right"></i>
          </span>
        </li>
      {% endif %}
    </ul>
    
    <div class="rdfs-pagination-info">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </div>
  </div>
  {% endif %}

</div>
<!-- DELETE CONFIRMATION MODAL -->
<div id="deleteModal" class="rdfs-modal-overlay hidden">
  <div class="rdfs-modal">
    
    <div class="rdfs-modal-header">
      <i class="fas fa-exclamation-triangle text-danger"></i>
      <h5>Confirm Deletion</h5>
    </div>

    <div class="rdfs-modal-body">
      <p id="deleteModalText">
        Are you sure you want to delete this item?
      </p>
      <p class="rdfs-modal-warning">
        This action cannot be undone.
      </p>
    </div>

    <div class="rdfs-modal-footer">
      <button type="button" class="btn-cancel" id="cancelDelete">
        Cancel
      </button>
      <button type="button" class="btn-confirm-delete" id="confirmDelete">
        <i class="fas fa-trash"></i> Delete
      </button>
    </div>

  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {

  /* =====================================================
     SEARCH FILTER
  ===================================================== */
  const searchInput = document.getElementById("rdfsVehicleSearch");

  if (searchInput) {
    searchInput.addEventListener("keyup", function () {
      const value = this.value.toLowerCase().trim();
      let visibleCount = 0;

      document.querySelectorAll(".rdfs-vehicle-card").forEach(card => {
        const searchText = card.dataset.search.toLowerCase();
        const isVisible = searchText.includes(value);

        card.style.display = isVisible ? "flex" : "none";
        if (isVisible) visibleCount++;
      });

      // Toggle empty state
      const emptyState = document.querySelector(".rdfs-empty-state");
      if (emptyState) {
        emptyState.style.display = visibleCount === 0 ? "block" : "none";
      }
    });
  }

  /* =====================================================
     DELETE MODAL LOGIC
  ===================================================== */
  const modal = document.getElementById("deleteModal");
  const modalText = document.getElementById("deleteModalText");
  const confirmBtn = document.getElementById("confirmDelete");
  const cancelBtn = document.getElementById("cancelDelete");

  let deleteUrl = null;

  /* OPEN MODAL */
  document.querySelectorAll(".btn-delete-item").forEach(btn => {
    btn.addEventListener("click", function () {
      deleteUrl = this.dataset.url;
      const name = this.dataset.name || "this item";

      modalText.innerHTML = `
        Are you sure you want to delete <strong>${name}</strong>?
      `;

      modal.classList.remove("hidden");
    });
  });

  /* CANCEL DELETE */
  cancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
    deleteUrl = null;
  });

  /* CONFIRM DELETE */
  confirmBtn.addEventListener("click", () => {
    if (!deleteUrl) return;

    confirmBtn.disabled = true;

    fetch(deleteUrl, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}"
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        modal.classList.add("hidden");

        // ✅ REFRESH PAGE AFTER DELETE
        setTimeout(() => {
          window.location.reload();
        }, 500); // delay so toast can appear
      } else {
        alert(data.message || "❌ Delete failed.");
      }
    })
    .catch(err => {
      console.error("Delete error:", err);
      alert("❌ Error deleting item.");
    })
    .finally(() => {
      confirmBtn.disabled = false;
    });
  });

  /* CLOSE MODAL ON BACKDROP CLICK */
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.add("hidden");
    }
  });

});
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".rdfs-toast").forEach(toast => {

    // Auto-hide after 5 seconds
    const timer = setTimeout(() => {
      toast.classList.add("hide");
      setTimeout(() => toast.remove(), 350);
    }, 5000);

    // Manual close
    toast.querySelector(".rdfs-toast-close")?.addEventListener("click", () => {
      clearTimeout(timer);
      toast.remove();
    });

  });
});
</script>

<style>
.rdfs-modal-overlay .rdfs-modal {
  max-width: 960px;
  width: min(95vw, 960px);
}

.rdfs-modal-overlay.hidden {
  display: none;
}

.rdfs-modal-overlay.active {
  display: flex;
}

body.rdfs-modal-open {
  overflow: hidden;
}

#vehicleEditModal .rdfs-modal-body {
  max-height: 78vh;
  overflow-y: auto;
  padding-right: 1rem;
}
</style>

<div id="vehicleEditModal" class="rdfs-modal-overlay hidden">
  <div class="rdfs-modal rdfs-modal-lg" role="dialog" aria-modal="true">
    <div class="rdfs-modal-header">
      <h5 class="mb-0">Edit Vehicle</h5>
      <button type="button" class="btn-close" aria-label="Close" data-modal-close></button>
    </div>
    <div class="rdfs-modal-body" id="vehicleEditModalBody">
      <div class="text-center py-4">Loading form...</div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const body = document.body;
  const modal = document.getElementById("vehicleEditModal");
  const modalBody = document.getElementById("vehicleEditModalBody");

  if (!modal || !modalBody) return;

  const loader = '<div class="text-center py-4">Loading form...</div>';

  const openModal = () => {
    modal.classList.remove("hidden");
    body.classList.add("rdfs-modal-open");
  };
  const closeModal = () => {
    modal.classList.add("hidden");
    body.classList.remove("rdfs-modal-open");
  };

  const bindForm = (form) => {
    if (!form) return;

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const submitButton = form.querySelector('[type="submit"]');
      submitButton?.setAttribute("disabled", "disabled");

      try {
        const response = await fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          credentials: "same-origin",
        });

        const data = await response.json();

        if (data.success) {
          closeModal();
          window.location.reload();
          return;
        }

        if (data.html) {
          modalBody.innerHTML = data.html;
          bindForm(modalBody.querySelector("form"));
        } else {
          modalBody.innerHTML = `<div class="text-danger p-3">${data.message || "Unable to save changes."}</div>`;
        }

      } catch (error) {
        modalBody.innerHTML = `<div class="text-danger p-3">${error.message}</div>`;
      } finally {
        submitButton?.removeAttribute("disabled");
      }
    });
  };

  const loadEditForm = async (url) => {
    if (!url) return;
    modalBody.innerHTML = loader;
    openModal();

    try {
      const response = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if (!response.ok) throw new Error("Failed to load edit form.");
      const payload = await response.json();
      modalBody.innerHTML = payload.html || "<div class=\"text-danger p-3\">Unable to load form.</div>";
      bindForm(modalBody.querySelector("form"));
    } catch (error) {
      modalBody.innerHTML = `<div class="text-danger p-3">${error.message}</div>`;
    }
  };

  document.querySelectorAll(".btn-edit-vehicle").forEach(button => {
    button.addEventListener("click", () => loadEditForm(button.dataset.editUrl));
  });

  modal.addEventListener("click", (event) => {
    if (event.target === modal || event.target.closest("[data-modal-close]")) {
      closeModal();
    }
  });
});
</script>


{% endblock %}