{% extends "base.html" %}
{% load static %}

{% block title %}Registered Vehicles | RDFS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/vehicles/vehicle-list.css' %}?v=1.0">
{% endblock %}

{% block content %}
<div class="vehicle-list-container">
  
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1 class="page-title">
        <i class="bi bi-truck-front-fill"></i>
        Registered Vehicles
      </h1>
      <p class="page-subtitle">
        View and manage all registered vehicles in the system
      </p>
    </div>
    <a href="{% if user.role == 'admin' %}{% url 'accounts:admin_dashboard' %}{% else %}{% url 'accounts:staff_dashboard' %}{% endif %}" class="btn-back">
      <i class="bi bi-arrow-left-circle"></i>
      Dashboard
    </a>
  </div>

  <!-- SEARCH & FILTER BAR -->
  <div class="search-container">
    <div class="search-wrapper">
      <i class="bi bi-search search-icon"></i>
      <input
        type="text"
        id="vehicleSearch"
        class="search-input"
        placeholder="Search by vehicle name, plate, VIN, or driver..."
        value="{{ request.GET.q }}"
        autocomplete="off"
      />
      <button type="button" id="clearSearch" class="btn-clear-search" style="display: none;">
        <i class="bi bi-x-circle-fill"></i>
      </button>
    </div>
    <div class="filter-controls">
      <div class="filter-group">
        <label for="sortBy">
          <i class="bi bi-sort-down"></i>
          Sort By:
        </label>
        <select id="sortBy" class="filter-select">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="name-asc">Name (A → Z)</option>
          <option value="name-desc">Name (Z → A)</option>
          <option value="expiry-near">Near Expiry</option>
          <option value="expiry-expired">Already Expired</option>
          <option value="expiry-longest">Longest Time Remaining</option>
          <option value="expiry-shortest">Shortest Time Remaining</option>
        </select>
      </div>
    </div>
    <div class="search-hint">
      <i class="bi bi-info-circle"></i>
      Search and filters apply automatically
    </div>
  </div>

  <!-- RESULTS COUNTER -->
  <div class="results-counter" id="resultsCounter">
    <span id="resultsText">
      Showing <strong>{{ vehicles.count }}</strong> vehicle{{ vehicles.count|pluralize }}
    </span>
  </div>

  <!-- VEHICLES TABLE -->
  <div class="table-container">
    <table class="vehicles-table" id="vehiclesTable">
      <thead>
        <tr>
          <th class="col-qr">QR Code</th>
          <th class="col-type">Type</th>
          <th class="col-name">Vehicle Name</th>
          <th class="col-plate">Plate Number</th>
          <th class="col-driver">Assigned Driver</th>
          <th class="col-expiry">Registration Expiry</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody id="vehiclesTableBody">
        {% for vehicle in vehicles %}
        <tr class="vehicle-row {% if vehicle.expiry_info.needs_alert %}expiry-alert-row{% endif %}" data-vehicle-id="{{ vehicle.id }}">
          <td class="col-qr">
            {% if vehicle.qr_code_url %}
              <img src="{{ vehicle.qr_code_url }}" alt="QR" class="qr-thumbnail">
            {% else %}
              <div class="qr-placeholder">
                <i class="bi bi-qr-code"></i>
              </div>
            {% endif %}
          </td>
          <td class="col-type">
            <div class="vehicle-type-badge">
              {% if vehicle.vehicle_type == 'jeepney' %}
                <i class="bi bi-truck"></i>
              {% elif vehicle.vehicle_type == 'van' %}
                <i class="bi bi-car-front"></i>
              {% elif vehicle.vehicle_type == 'bus' %}
                <i class="bi bi-bus-front"></i>
              {% endif %}
              {{ vehicle.get_vehicle_type_display }}
            </div>
          </td>
          <td class="col-name">
            <div class="vehicle-name">{{ vehicle.vehicle_name }}</div>
          </td>
          <td class="col-plate">
            <span class="plate-badge">{{ vehicle.license_plate }}</span>
          </td>
          <td class="col-driver">
            {% if vehicle.assigned_driver %}
              <div class="driver-info">
                {% if vehicle.assigned_driver.driver_photo %}
                  <img src="{{ vehicle.assigned_driver.driver_photo.url }}" alt="{{ vehicle.assigned_driver.first_name }}" class="driver-photo-small">
                {% else %}
                  <div class="driver-photo-placeholder-small">
                    <i class="bi bi-person"></i>
                  </div>
                {% endif %}
                <span>{{ vehicle.assigned_driver.first_name }} {{ vehicle.assigned_driver.last_name }}</span>
              </div>
            {% else %}
              <span class="text-muted">No driver</span>
            {% endif %}
          </td>
          <td class="col-expiry">
            {% if vehicle.expiry_info.expiry_date %}
              <div class="expiry-info">
                <span class="expiry-date expiry-{{ vehicle.expiry_info.status }}">
                  {{ vehicle.expiry_info.expiry_date|date:"M d, Y" }}
                </span>
                {% if vehicle.expiry_info.needs_alert %}
                  <span class="expiry-alert-badge">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    {{ vehicle.expiry_info.message }}
                  </span>
                {% endif %}
              </div>
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
          <td class="col-actions">
            <div class="action-buttons">
              <a href="{% url 'vehicles:vehicle_detail' vehicle.id %}" class="btn-action btn-view">
                <i class="bi bi-eye"></i>
                View
              </a>
              <a href="{% url 'vehicles:vehicle_qr' vehicle.id %}" target="_blank" class="btn-action btn-print">
                <i class="bi bi-printer"></i>
                Print
              </a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr class="empty-row">
          <td colspan="7" class="text-center py-5">
            <div class="empty-state">
              <i class="bi bi-truck-front"></i>
              <p>No vehicles found</p>
              <small class="text-muted">Try adjusting your search</small>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- LOADING INDICATOR -->
  <div id="loadingIndicator" class="loading-indicator" style="display: none;">
    <div class="spinner"></div>
    <span>Searching...</span>
  </div>

</div>

<script src="{% static 'js/vehicles/vehicle-list-search.js' %}?v=1.0"></script>
{% endblock %}
