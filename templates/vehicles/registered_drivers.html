{% extends "base.html" %}
{% load static %}

{% block title %}Registered Drivers | RDFS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/vehicles/driver-list.css' %}?v=2.0">
{% endblock %}

{% block content %}
<div class="driver-list-container">
  
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1 class="page-title">
        <i class="bi bi-people-fill"></i>
        Registered Drivers
      </h1>
      <p class="page-subtitle">
        View and manage all registered drivers in the system
      </p>
    </div>
    <a href="{% if user.role == 'admin' %}{% url 'accounts:admin_dashboard' %}{% else %}{% url 'accounts:staff_dashboard' %}{% endif %}" class="btn-back">
      <i class="bi bi-arrow-left-circle"></i>
      Dashboard
    </a>
  </div>

  <!-- SEARCH & FILTER BAR -->
  <div class="search-container">
    <div class="search-wrapper">
      <i class="bi bi-search search-icon"></i>
      <input
        type="text"
        id="driverSearch"
        class="search-input"
        placeholder="Search by name, license number, or contact..."
        value="{{ request.GET.q }}"
        autocomplete="off"
      />
      <button type="button" id="clearSearch" class="btn-clear-search" style="display: none;">
        <i class="bi bi-x-circle-fill"></i>
      </button>
    </div>
    <div class="filter-controls">
      <div class="filter-group">
        <label for="sortBy">
          <i class="bi bi-sort-down"></i>
          Sort By:
        </label>
        <select id="sortBy" class="filter-select">
          <option value="name-asc">Name (A → Z)</option>
          <option value="name-desc">Name (Z → A)</option>
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="expiry-near">Near Expiry</option>
          <option value="expiry-expired">Already Expired</option>
          <option value="expiry-longest">Longest Time Remaining</option>
          <option value="expiry-shortest">Shortest Time Remaining</option>
        </select>
      </div>
    </div>
    <div class="search-hint">
      <i class="bi bi-info-circle"></i>
      Search and filters apply automatically
    </div>
  </div>

  <!-- RESULTS COUNTER -->
  <div class="results-counter" id="resultsCounter">
    <span id="resultsText">
      Showing <strong>{{ drivers.count }}</strong> driver{{ drivers.count|pluralize }}
    </span>
  </div>

  <!-- DRIVERS TABLE -->
  <div class="table-container">
    <table class="drivers-table" id="driversTable">
      <thead>
        <tr>
          <th class="col-photo">Photo</th>
          <th class="col-name">Full Name</th>
          <th class="col-license">License Number</th>
          <th class="col-expiry">License Expiry</th>
          <th class="col-contact">Contact</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody id="driversTableBody">
        {% for driver in drivers %}
        <tr class="driver-row {% if driver.expiry_info.needs_alert %}expiry-alert-row{% endif %}" data-driver-id="{{ driver.id }}">
          <td class="col-photo">
            {% if driver.driver_photo %}
              <img src="{{ driver.driver_photo.url }}" alt="{{ driver.first_name }}" class="driver-photo">
            {% else %}
              <div class="driver-photo-placeholder">
                <i class="bi bi-person-circle"></i>
              </div>
            {% endif %}
          </td>
          <td class="col-name">
            <div class="driver-name">
              {{ driver.first_name }} 
              {% if driver.middle_name %}{{ driver.middle_name|slice:":1" }}.{% endif %} 
              {{ driver.last_name }}
              {% if driver.suffix %} {{ driver.suffix }}{% endif %}
            </div>
          </td>
          <td class="col-license">
            <span class="license-badge">{{ driver.license_number }}</span>
          </td>
          <td class="col-expiry">
            {% if driver.expiry_info.expiry_date %}
              <div class="expiry-info">
                <span class="expiry-date expiry-{{ driver.expiry_info.status }}">
                  {{ driver.expiry_info.expiry_date|date:"M d, Y" }}
                </span>
                {% if driver.expiry_info.needs_alert %}
                  <span class="expiry-alert-badge">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    {{ driver.expiry_info.message }}
                  </span>
                {% endif %}
              </div>
            {% else %}
              <span class="text-muted">N/A</span>
            {% endif %}
          </td>
          <td class="col-contact">
            <div class="contact-info">
              <div><i class="bi bi-telephone"></i> {{ driver.mobile_number }}</div>
              <div class="text-muted small"><i class="bi bi-envelope"></i> {{ driver.email|truncatechars:25 }}</div>
            </div>
          </td>
          <td class="col-actions">
            <a href="{% url 'vehicles:driver_detail' driver.id %}" class="btn-action btn-view">
              <i class="bi bi-eye"></i>
              View Details
            </a>
          </td>
        </tr>
        {% empty %}
        <tr class="empty-row">
          <td colspan="6" class="text-center py-5">
            <div class="empty-state">
              <i class="bi bi-person-x"></i>
              <p>No drivers found</p>
              <small class="text-muted">Try adjusting your search</small>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- LOADING INDICATOR -->
  <div id="loadingIndicator" class="loading-indicator" style="display: none;">
    <div class="spinner"></div>
    <span>Searching...</span>
  </div>

</div>

<script src="{% static 'js/vehicles/driver-list-search.js' %}?v=2.0"></script>
{% endblock %}
