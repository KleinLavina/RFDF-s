{% extends "base.html" %}
{% load static %}

{% block title %}Register Driver | RDFS{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'styles/vehicles/01.css' %}">
<!-- Font Awesome Icons -->


<div class="container py-4 form-container">

 <div class="rdfs-page-header">
    <div>
      <div class="rdfs-page-title">
        <i class="fas fa-user-plus me-2"></i> Register Driver
      </div>
      <div class="rdfs-page-sub">
        Add a new driver to the RDFS system
      </div>
    </div>

    <a href="{% url 'accounts:staff_dashboard' %}" class="rdfs-return-btn">
      <i class="fas fa-arrow-left-circle me-1"></i> Dashboard
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      <strong>Form Errors:</strong>
      <ul class="mb-0">
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="POST" enctype="multipart/form-data"
        hx-post="{% url 'vehicles:register_driver' %}"
        hx-target="#main-content"
        hx-swap="innerHTML transition:true"
        novalidate
        id="driverForm">
    {% csrf_token %}


    <!-- ðŸ“¸ DRIVER PHOTO CAPTURE SECTION -->
    <div class="section-box camera-section">
      <div class="section-title">
        <i class="fas fa-camera me-2"></i> Driver Photo Capture
      </div>

      <div class="camera-card">
        <!-- Start Camera Button -->
        <div id="startCameraSection" class="text-center mb-3">
          <button type="button" id="startCameraBtn" class="btn btn-primary btn-lg">
            <i class="fas fa-video me-2"></i>
            Open Camera
          </button>
          <p class="text-muted small mt-2 mb-0">
            Click to allow camera access for driver photo capture
          </p>
        </div>

        <!-- Live camera stream -->
        <video id="cameraStream"
              autoplay
              playsinline
              class="camera-preview d-none">
        </video>

        <!-- Captured image preview (hidden initially) -->
        <canvas id="photoCanvas" style="display:none;"></canvas>
        <img id="photoPreview"
            class="camera-preview"
            style="display:none;">

        <!-- Hidden file input (Django needs this) -->
        <input type="file"
              name="driver_photo"
              id="id_driver_photo"
              style="display:none;"
              required>

        <button type="button" class="capture-btn" id="captureBtn" disabled>
          <i class="fas fa-camera me-1"></i> Capture Photo
        </button>

        <div class="camera-hint">
          <i class="fas fa-info-circle me-1"></i> Camera capture only â€¢ No file uploads allowed
        </div>

        {% if form.driver_photo.errors %}
          <div class="invalid-feedback d-block mt-2">
            {{ form.driver_photo.errors.0 }}
          </div>
        {% endif %}
      </div>
    </div>


    <!-- PERSONAL INFORMATION -->
    <div class="section-box">
      <div class="section-title">
        <i class="fas fa-id-card me-2"></i> Personal Information
      </div>

      <div class="row g-3">
        <div class="col-md-3">
          <label for="id_first_name" class="form-label required">
            <i class="fas fa-signature me-1"></i> First Name
          </label>
          <input type="text" class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" 
                 id="id_first_name" name="first_name" 
                 value="{{ form.first_name.value|default:'' }}" 
                 placeholder="Enter first name"
                 required>
          {% if form.first_name.errors %}
            <div class="invalid-feedback">
              {{ form.first_name.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-3">
          <label for="id_middle_name" class="form-label">
            <i class="fas fa-signature me-1"></i> Middle Name
          </label>
          <input type="text" class="form-control {% if form.middle_name.errors %}is-invalid{% endif %}" 
                 id="id_middle_name" name="middle_name" 
                 value="{{ form.middle_name.value|default:'' }}"
                 placeholder="Enter middle name (optional)">
          {% if form.middle_name.errors %}
            <div class="invalid-feedback">
              {{ form.middle_name.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-3">
          <label for="id_last_name" class="form-label required">
            <i class="fas fa-signature me-1"></i> Last Name
          </label>
          <input type="text" class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" 
                 id="id_last_name" name="last_name" 
                 value="{{ form.last_name.value|default:'' }}" 
                 placeholder="Enter last name"
                 required>
          {% if form.last_name.errors %}
            <div class="invalid-feedback">
              {{ form.last_name.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-3">
          <label for="id_suffix" class="form-label">
            <i class="fas fa-text-height me-1"></i> Suffix
          </label>
          <input type="text" class="form-control {% if form.suffix.errors %}is-invalid{% endif %}" 
                 id="id_suffix" name="suffix" 
                 value="{{ form.suffix.value|default:'' }}"
                 placeholder="e.g., Jr., Sr., III">
          {% if form.suffix.errors %}
            <div class="invalid-feedback">
              {{ form.suffix.errors.0 }}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label required">
            <i class="fas fa-birthday-cake me-1"></i> Birth Date
          </label>
          <div class="date-wrapper">
            {{ form.birth_date }}
            <div class="custom-calendar" id="calendar_birth"></div>
          </div>
        </div>

        <div class="col-md-4">
          <label for="id_birth_place" class="form-label required">
            <i class="fas fa-map-marker-alt me-1"></i> Birth Place
          </label>
          <input type="text" class="form-control {% if form.birth_place.errors %}is-invalid{% endif %}" 
                 id="id_birth_place" name="birth_place" 
                 value="{{ form.birth_place.value|default:'' }}" 
                 placeholder="City/Municipality, Province"
                 required>
          {% if form.birth_place.errors %}
            <div class="invalid-feedback">
              {{ form.birth_place.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-4">
          <label for="id_blood_type" class="form-label required">
            <i class="fas fa-tint me-1"></i> Blood Type
          </label>
          <select class="form-select {% if form.blood_type.errors %}is-invalid{% endif %}" 
                 id="id_blood_type" name="blood_type" required>
            <option value="" disabled {% if not form.blood_type.value %}selected{% endif %}>Select blood type</option>
            <option value="A+" {% if form.blood_type.value == 'A+' %}selected{% endif %}>A+</option>
            <option value="A-" {% if form.blood_type.value == 'A-' %}selected{% endif %}>A-</option>
            <option value="B+" {% if form.blood_type.value == 'B+' %}selected{% endif %}>B+</option>
            <option value="B-" {% if form.blood_type.value == 'B-' %}selected{% endif %}>B-</option>
            <option value="AB+" {% if form.blood_type.value == 'AB+' %}selected{% endif %}>AB+</option>
            <option value="AB-" {% if form.blood_type.value == 'AB-' %}selected{% endif %}>AB-</option>
            <option value="O+" {% if form.blood_type.value == 'O+' %}selected{% endif %}>O+</option>
            <option value="O-" {% if form.blood_type.value == 'O-' %}selected{% endif %}>O-</option>
            <option value="N/A" {% if form.blood_type.value == 'N/A' %}selected{% endif %}>Prefer not to say</option>
          </select>
          {% if form.blood_type.errors %}
            <div class="invalid-feedback">
              {{ form.blood_type.errors.0 }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>


    <!-- CONTACT INFORMATION -->
    <div class="section-box">
      <div class="section-title">
        <i class="fas fa-address-book me-2"></i> Contact Information
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label for="id_mobile_number" class="form-label required">
            <i class="fas fa-mobile-alt me-1"></i> Mobile Number
          </label>
          <input type="tel" class="form-control {% if form.mobile_number.errors %}is-invalid{% endif %}" 
                 id="id_mobile_number" name="mobile_number" 
                 value="{{ form.mobile_number.value|default:'' }}" 
                 placeholder="e.g., 09123456789 or +639123456789"
                 required>
          <small class="form-text text-muted">
            <i class="fas fa-info-circle me-1"></i> Format: 09123456789 or +639123456789
          </small>
          {% if form.mobile_number.errors %}
            <div class="invalid-feedback">
              {{ form.mobile_number.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-6">
          <label for="id_email" class="form-label required">
            <i class="fas fa-envelope me-1"></i> Email Address
          </label>
          <input type="email" class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                 id="id_email" name="email" 
                 value="{{ form.email.value|default:'' }}" 
                 placeholder="e.g., juan.delacruz@example.com"
                 required>
          {% if form.email.errors %}
            <div class="invalid-feedback">
              {{ form.email.errors.0 }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>


    <!-- ADDRESS INFORMATION -->
    <div class="section-box">
      <div class="section-title">
        <i class="fas fa-home me-2"></i> Address Information
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <label for="id_street" class="form-label required">
            <i class="fas fa-road me-1"></i> Street
          </label>
          <input type="text" class="form-control {% if form.street.errors %}is-invalid{% endif %}" 
                 id="id_street" name="street" 
                 value="{{ form.street.value|default:'' }}" 
                 placeholder="e.g., 123 Main Street"
                 required>
          {% if form.street.errors %}
            <div class="invalid-feedback">
              {{ form.street.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-4">
          <label for="id_barangay" class="form-label required">
            <i class="fas fa-map-pin me-1"></i> Barangay
          </label>
          <input type="text" class="form-control {% if form.barangay.errors %}is-invalid{% endif %}" 
                 id="id_barangay" name="barangay" 
                 value="{{ form.barangay.value|default:'' }}" 
                 placeholder="e.g., Barangay 123"
                 required>
          {% if form.barangay.errors %}
            <div class="invalid-feedback">
              {{ form.barangay.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-4">
          <label for="id_zip_code" class="form-label required">
            <i class="fas fa-mail-bulk me-1"></i> ZIP Code
          </label>
          <input type="text" class="form-control {% if form.zip_code.errors %}is-invalid{% endif %}" 
                 id="id_zip_code" name="zip_code" 
                 value="{{ form.zip_code.value|default:'' }}" 
                 placeholder="e.g., 1000"
                 pattern="[0-9]{4}"
                 title="Please enter a valid 4-digit ZIP code"
                 required>
          <small class="form-text text-muted">
            <i class="fas fa-info-circle me-1"></i> 4-digit ZIP code
          </small>
          {% if form.zip_code.errors %}
            <div class="invalid-feedback">
              {{ form.zip_code.errors.0 }}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label for="id_city_municipality" class="form-label required">
            <i class="fas fa-city me-1"></i> City / Municipality
          </label>
          <input type="text" class="form-control {% if form.city_municipality.errors %}is-invalid{% endif %}" 
                 id="id_city_municipality" name="city_municipality" 
                 value="{{ form.city_municipality.value|default:'' }}" 
                 placeholder="e.g., Manila, Quezon City"
                 required>
          {% if form.city_municipality.errors %}
            <div class="invalid-feedback">
              {{ form.city_municipality.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-6">
          <label for="id_province" class="form-label required">
            <i class="fas fa-map me-1"></i> Province
          </label>
          <input type="text" class="form-control {% if form.province.errors %}is-invalid{% endif %}" 
                 id="id_province" name="province" 
                 value="{{ form.province.value|default:'' }}" 
                 placeholder="e.g., Metro Manila, Bulacan"
                 required>
          {% if form.province.errors %}
            <div class="invalid-feedback">
              {{ form.province.errors.0 }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>


    <!-- LICENSE INFORMATION -->
    <div class="section-box">
      <div class="section-title">
        <i class="fas fa-id-card me-2"></i> Driver's License Information
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <label for="id_license_number" class="form-label required">
            <i class="fas fa-file-alt me-1"></i> License Number
          </label>
          <input type="text" class="form-control {% if form.license_number.errors %}is-invalid{% endif %}" 
                 id="id_license_number" name="license_number" 
                 value="{{ form.license_number.value|default:'' }}" 
                 placeholder="Enter license number"
                 required>
          <small class="form-text text-muted">
            <i class="fas fa-info-circle me-1"></i> Enter your driver's license number (minimum 5 characters)
          </small>
          {% if form.license_number.errors %}
            <div class="invalid-feedback">
              {{ form.license_number.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-4">
          <label class="form-label required">
            <i class="fas fa-calendar-times me-1"></i> License Expiry
          </label>
          <div class="date-wrapper">
            {{ form.license_expiry }}
            <div class="custom-calendar" id="calendar_expiry"></div>
          </div>
        </div>

        <div class="col-md-4">
          <label for="id_license_type" class="form-label required">
            <i class="fas fa-car me-1"></i> License Type
          </label>
          <input type="text" 
                 class="form-control" 
                 id="id_license_type" 
                 name="license_type" 
                 value="Professional Driver's License" 
                 readonly
                 required>
          <small class="form-text text-muted">
            <i class="fas fa-info-circle me-1"></i> Only professional licenses accepted
          </small>
        </div>
      </div>
    </div>


    <!-- EMERGENCY CONTACT -->
    <div class="section-box">
      <div class="section-title">
        <i class="fas fa-phone-alt me-2"></i> Emergency Contact
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <label for="id_emergency_contact_name" class="form-label required">
            <i class="fas fa-user-friends me-1"></i> Contact Name
          </label>
          <input type="text" class="form-control {% if form.emergency_contact_name.errors %}is-invalid{% endif %}" 
                 id="id_emergency_contact_name" name="emergency_contact_name" 
                 value="{{ form.emergency_contact_name.value|default:'' }}" 
                 placeholder="Full name of emergency contact"
                 required>
          {% if form.emergency_contact_name.errors %}
            <div class="invalid-feedback">
              {{ form.emergency_contact_name.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-4">
          <label for="id_emergency_contact_number" class="form-label required">
            <i class="fas fa-phone me-1"></i> Contact Number
          </label>
          <input type="tel" class="form-control {% if form.emergency_contact_number.errors %}is-invalid{% endif %}" 
                 id="id_emergency_contact_number" name="emergency_contact_number" 
                 value="{{ form.emergency_contact_number.value|default:'' }}" 
                 placeholder="e.g., 09123456789 or +639123456789"
                 required>
          <small class="form-text text-muted">
            <i class="fas fa-info-circle me-1"></i> Format: 09123456789 or +639123456789
          </small>
          {% if form.emergency_contact_number.errors %}
            <div class="invalid-feedback">
              {{ form.emergency_contact_number.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="col-md-4">
          <label for="id_emergency_contact_relationship" class="form-label required">
            <i class="fas fa-heart me-1"></i> Relationship
          </label>
          <input type="text" class="form-control {% if form.emergency_contact_relationship.errors %}is-invalid{% endif %}" 
                 id="id_emergency_contact_relationship" name="emergency_contact_relationship" 
                 value="{{ form.emergency_contact_relationship.value|default:'' }}" 
                 placeholder="e.g., Spouse, Parent, Sibling"
                 required>
          {% if form.emergency_contact_relationship.errors %}
            <div class="invalid-feedback">
              {{ form.emergency_contact_relationship.errors.0 }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>


    <!-- FOOTER BUTTONS -->
    <div class="d-flex justify-content-end gap-2">
      <a href="{% url 'accounts:staff_dashboard' %}" class="btn btn-outline-secondary px-4">
        <i class="fas fa-times-circle me-1"></i> Cancel
      </a>
      <button type="submit" class="btn btn-success px-4">
        <i class="fas fa-check-circle me-1"></i> Register Driver
      </button>
    </div>

  </form>

</div>
<script>
  /* =====================================================
   CUSTOM DATE PICKER (SAFE VERSION)
===================================================== */
function createCustomCalendar(inputFieldId, calendarBoxId, minYear, maxYear) {
    const input = document.getElementById(inputFieldId);
    const box = document.getElementById(calendarBoxId);

    // ðŸ”’ SAFETY GUARD (CRITICAL)
    if (!input || !box) {
        console.warn(
            `Calendar skipped: ${!input ? inputFieldId : ""} ${!box ? calendarBoxId : ""}`
        );
        return;
    }

    input.type = "text";

    const today = new Date();
    let selected = null;
    let month = today.getMonth();
    let year = today.getFullYear();

    function render() {
        box.innerHTML = "";

        /* HEADER */
        const header = document.createElement("div");
        header.className = "cal-header";

        const monthSelect = document.createElement("select");
        const months = [
            "January","February","March","April","May","June",
            "July","August","September","October","November","December"
        ];

        months.forEach((m, i) => {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = m;
            if (i === month) opt.selected = true;
            monthSelect.appendChild(opt);
        });

        const yearSelect = document.createElement("select");
        for (let y = minYear; y <= maxYear; y++) {
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y;
            if (y === year) opt.selected = true;
            yearSelect.appendChild(opt);
        }

        monthSelect.onchange = () => {
            month = parseInt(monthSelect.value);
            render();
        };

        yearSelect.onchange = () => {
            year = parseInt(yearSelect.value);
            render();
        };

        header.appendChild(monthSelect);
        header.appendChild(yearSelect);
        box.appendChild(header);

        /* DAYS HEADER */
        const daysRow = document.createElement("div");
        daysRow.className = "cal-days";
        ["Su","Mo","Tu","We","Th","Fr","Sa"].forEach(d => {
            const el = document.createElement("div");
            el.textContent = d;
            daysRow.appendChild(el);
        });
        box.appendChild(daysRow);

        /* GRID */
        const grid = document.createElement("div");
        grid.className = "cal-grid";
        box.appendChild(grid);

        const firstDay = new Date(year, month, 1).getDay();
        const totalDays = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            grid.appendChild(document.createElement("div"));
        }

        for (let d = 1; d <= totalDays; d++) {
            const dayBtn = document.createElement("div");
            dayBtn.className = "cal-day";
            dayBtn.textContent = d;

            const todayObj = new Date();
            if (
                year === todayObj.getFullYear() &&
                month === todayObj.getMonth() &&
                d === todayObj.getDate()
            ) {
                dayBtn.classList.add("today");
            }

            if (
                selected &&
                selected.year === year &&
                selected.month === month &&
                selected.day === d
            ) {
                dayBtn.classList.add("selected");
            }

            dayBtn.onclick = () => {
                selected = { year, month, day: d };
                input.value =
                    `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
                box.style.display = "none";
            };

            grid.appendChild(dayBtn);
        }
    }

    input.addEventListener("click", () => {
        box.style.display = "block";
        render();
    });

    document.addEventListener("click", (e) => {
        if (!box.contains(e.target) && e.target !== input) {
            box.style.display = "none";
        }
    });
}

/* =====================================================
   INITIALIZE CALENDARS (AFTER DOM READY)
===================================================== */
document.addEventListener("DOMContentLoaded", () => {
    createCustomCalendar(
        "id_birth_date",
        "calendar_birth",
        1950,
        new Date().getFullYear()
    );

    createCustomCalendar(
        "id_license_expiry",
        "calendar_expiry",
        2024,
        2045
    );
});


/* =====================================================
   CAMERA CAPTURE (SAFE + ASYNC)
===================================================== */
document.addEventListener("DOMContentLoaded", () => {
    const video = document.getElementById("cameraStream");
    const canvas = document.getElementById("photoCanvas");
    const preview = document.getElementById("photoPreview");
    const captureBtn = document.getElementById("captureBtn");
    const fileInput = document.getElementById("id_driver_photo");
    const startSection = document.getElementById("startCameraSection");
    const startBtn = document.getElementById("startCameraBtn");

    if (!video || !canvas || !preview || !captureBtn || !fileInput || !startSection || !startBtn) {
        console.warn("Camera capture skipped: required elements not found");
        return;
    }

    let cameraStream = null;
    let cameraActive = false;

    const setCaptureMode = (mode) => {
        captureBtn.dataset.mode = mode;
        if (mode === "capture") {
            captureBtn.innerHTML = '<i class="fas fa-camera me-1"></i> Capture Photo';
        } else {
            captureBtn.innerHTML = '<i class="fas fa-undo me-1"></i> Retake Photo';
        }
    };

    setCaptureMode("capture");

    async function requestCameraStream() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error("Camera API not supported in this browser.");
        }

        const constraintsList = [
            { video: { facingMode: { ideal: "environment" } }, audio: false },
            { video: true, audio: false },
        ];

        let lastError = null;

        for (const constraints of constraintsList) {
            try {
                return await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                lastError = err;
                // For user gesture requirements we should break on permission denial
                if (err && (err.name === "NotAllowedError" || err.name === "PermissionDeniedError")) {
                    break;
                }
            }
        }

        throw lastError || new Error("Camera access failed.");
    }

    async function openCamera() {
        startBtn.disabled = true;

        try {
            cameraStream = await requestCameraStream();

            video.srcObject = cameraStream;
            video.classList.remove("d-none");

            video.style.display = "block";
            preview.style.display = "none";

            startSection.classList.add("d-none");
            captureBtn.disabled = false;
            setCaptureMode("capture");
            cameraActive = true;
        } catch (err) {
            const message = err && err.message ? err.message : "Camera access denied or not available.";
            alert(message);
            startBtn.disabled = false;
            setCaptureMode("capture");
        }
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }

        cameraActive = false;
        captureBtn.disabled = true;
        preview.style.display = "none";
        video.classList.add("d-none");
        startSection.classList.remove("d-none");
        startBtn.disabled = false;
        setCaptureMode("capture");
    }

    function captureFrame() {
        const width = video.videoWidth;
        const height = video.videoHeight;

        if (!width || !height) return;

        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, width, height);

        canvas.toBlob(blob => {
            if (!blob) return;

            const file = new File([blob], "driver_photo.jpg", { type: "image/jpeg" });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;

            preview.src = URL.createObjectURL(blob);
            preview.style.display = "block";
            video.style.display = "none";
            setCaptureMode("retake");
        }, "image/jpeg", 0.92);
    }

    function retakePhoto() {
        preview.style.display = "none";
        video.style.display = "block";
        setCaptureMode("capture");
    }

    function handleCaptureClick() {
        if (!cameraActive) {
            alert("Please open the camera first.");
            return;
        }

        if (captureBtn.dataset.mode === "retake") {
            retakePhoto();
        } else {
            captureFrame();
        }
    }

    startBtn.addEventListener("click", openCamera);
    captureBtn.addEventListener("click", handleCaptureClick);

    document.addEventListener("htmx:beforeSwap", stopCamera);
    window.addEventListener("beforeunload", stopCamera);
});
</script>

{% endblock %}