{% extends "base.html" %}
{% load static %}

{% block title %}{{ vehicle.vehicle_name }} | Vehicle Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/vehicles/vehicle-detail.css' %}?v=1.0">
{% endblock %}

{% block content %}
<div class="vehicle-detail-container">
  
  <!-- HEADER -->
  <div class="detail-header">
    <a href="{% url 'vehicles:registered_vehicles' %}" class="btn-back">
      <i class="bi bi-arrow-left-circle"></i>
      Back to Vehicles
    </a>
    <div class="header-actions">
      <a href="{% url 'vehicles:vehicle_qr' vehicle.id %}" target="_blank" class="btn-action btn-print">
        <i class="bi bi-printer"></i>
        Print QR
      </a>
      <button type="button" class="btn-action btn-edit" id="btnToggleEdit">
        <i class="bi bi-pencil-square"></i>
        <span id="editButtonText">Edit Vehicle</span>
      </button>
      {% if user.is_superuser or user.role == 'admin' %}
      <button type="button" class="btn-action btn-delete" id="btnDeleteVehicle">
        <i class="bi bi-trash"></i>
        Delete
      </button>
      {% endif %}
    </div>
  </div>

  <!-- VEHICLE PROFILE CARD -->
  <div class="profile-card {% if vehicle.expiry_info.needs_alert %}profile-card-alert{% endif %}">
    {% if vehicle.expiry_info.needs_alert %}
    <div class="profile-alert-banner">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <span>{{ vehicle.expiry_info.message }}</span>
    </div>
    {% endif %}
    <div class="profile-qr-section">
      {% if vehicle.qr_code_url %}
        <img src="{{ vehicle.qr_code_url }}" alt="QR Code" class="profile-qr">
      {% else %}
        <div class="profile-qr-placeholder">
          <i class="bi bi-qr-code"></i>
        </div>
      {% endif %}
    </div>
    
    <div class="profile-info-section">
      <h1 class="vehicle-name">{{ vehicle.vehicle_name }}</h1>
      <div class="vehicle-plate-badge">
        <i class="bi bi-credit-card-2-front"></i>
        {{ vehicle.license_plate }}
      </div>
      <div class="profile-meta">
        <div class="meta-item">
          <i class="bi bi-car-front"></i>
          <span>{{ vehicle.get_vehicle_type_display }}</span>
        </div>
        <div class="meta-item">
          <i class="bi bi-calendar"></i>
          <span>{{ vehicle.year_model }}</span>
        </div>
        {% if vehicle.route %}
        <div class="meta-item">
          <i class="bi bi-signpost-2"></i>
          <span>{{ vehicle.route }}</span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- CONTENT GRID -->
  <div class="content-grid">
    
    <!-- EDIT FORM (Hidden by default) -->
    <form id="vehicleEditForm" class="edit-form-container" style="display: none;" method="POST" action="{% url 'vehicles:edit_vehicle' vehicle.id %}">
      {% csrf_token %}
      
      <div class="form-section">
        <h3 class="form-section-title">
          <i class="bi bi-truck-front-fill"></i>
          Vehicle Information
        </h3>
        <div class="form-grid">
          <div class="form-field full-width">
            <label for="id_vehicle_name">Vehicle Name *</label>
            <input type="text" name="vehicle_name" id="id_vehicle_name" value="{{ vehicle.vehicle_name }}" required>
          </div>
          <div class="form-field">
            <label for="id_vehicle_type">Vehicle Type *</label>
            <select name="vehicle_type" id="id_vehicle_type" required>
              <option value="jeepney" {% if vehicle.vehicle_type == 'jeepney' %}selected{% endif %}>Jeepney</option>
              <option value="van" {% if vehicle.vehicle_type == 'van' %}selected{% endif %}>Van</option>
              <option value="bus" {% if vehicle.vehicle_type == 'bus' %}selected{% endif %}>Bus</option>
            </select>
          </div>
          <div class="form-field">
            <label for="id_ownership_type">Ownership Type *</label>
            <select name="ownership_type" id="id_ownership_type" required>
              <option value="owned" {% if vehicle.ownership_type == 'owned' %}selected{% endif %}>Owned</option>
              <option value="leased" {% if vehicle.ownership_type == 'leased' %}selected{% endif %}>Leased</option>
              <option value="private" {% if vehicle.ownership_type == 'private' %}selected{% endif %}>Private</option>
            </select>
          </div>
          <div class="form-field">
            <label for="id_year_model">Year Model *</label>
            <input type="number" name="year_model" id="id_year_model" value="{{ vehicle.year_model }}" min="1886" max="2027" required>
          </div>
          <div class="form-field">
            <label for="id_seat_capacity">Seat Capacity</label>
            <input type="number" name="seat_capacity" id="id_seat_capacity" value="{{ vehicle.seat_capacity|default:'' }}" min="1">
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="form-section-title">
          <i class="bi bi-person-fill"></i>
          Driver & Route Assignment
        </h3>
        <div class="form-grid">
          <div class="form-field">
            <label for="id_assigned_driver">Assigned Driver *</label>
            <select name="assigned_driver" id="id_assigned_driver" required>
              {% for driver in all_drivers %}
              <option value="{{ driver.id }}" {% if vehicle.assigned_driver.id == driver.id %}selected{% endif %}>
                {{ driver.first_name }} {{ driver.last_name }} ({{ driver.driver_id }})
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-field">
            <label for="id_route">Route</label>
            <select name="route" id="id_route">
              <option value="">No Route</option>
              {% for route in all_routes %}
              <option value="{{ route.id }}" {% if vehicle.route and vehicle.route.id == route.id %}selected{% endif %}>
                {{ route.name }}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="form-section-title">
          <i class="bi bi-file-earmark-text-fill"></i>
          Registration Details
        </h3>
        <div class="form-grid">
          <div class="form-field">
            <label for="id_registration_number">Registration Number *</label>
            <input type="text" name="registration_number" id="id_registration_number" value="{{ vehicle.registration_number }}" required>
          </div>
          <div class="form-field">
            <label for="id_registration_expiry">Registration Expiry</label>
            <input type="date" name="registration_expiry" id="id_registration_expiry" value="{{ vehicle.registration_expiry|date:'Y-m-d' }}">
          </div>
          <div class="form-field">
            <label for="id_license_plate">License Plate *</label>
            <input type="text" name="license_plate" id="id_license_plate" value="{{ vehicle.license_plate }}" required>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="form-section-title">
          <i class="bi bi-folder-fill"></i>
          Documentation
        </h3>
        <div class="form-grid">
          <div class="form-field">
            <label for="id_cr_number">CR Number *</label>
            <input type="text" name="cr_number" id="id_cr_number" value="{{ vehicle.cr_number }}" required>
          </div>
          <div class="form-field">
            <label for="id_or_number">OR Number *</label>
            <input type="text" name="or_number" id="id_or_number" value="{{ vehicle.or_number }}" required>
          </div>
          <div class="form-field">
            <label for="id_vin_number">VIN Number *</label>
            <input type="text" name="vin_number" id="id_vin_number" value="{{ vehicle.vin_number }}" maxlength="17" required>
            <small class="form-help">17 characters (excluding I, O, Q)</small>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancel" id="btnCancelEdit">
          <i class="bi bi-x-circle"></i>
          Cancel
        </button>
        <button type="submit" class="btn-save">
          <i class="bi bi-check-circle"></i>
          Save Changes
        </button>
      </div>
    </form>

    <!-- VIEW MODE (Default) -->
    <div id="vehicleViewMode" class="view-mode-container">
    
    <!-- VEHICLE INFORMATION -->
    <div class="info-section">
      <div class="section-header">
        <i class="bi bi-truck-front-fill"></i>
        <h2>Vehicle Information</h2>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Vehicle Type</span>
          <span class="info-value">{{ vehicle.get_vehicle_type_display }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Ownership Type</span>
          <span class="info-value">{{ vehicle.get_ownership_type_display }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Year Model</span>
          <span class="info-value">{{ vehicle.year_model }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Seat Capacity</span>
          <span class="info-value">{{ vehicle.seat_capacity|default:"N/A" }}</span>
        </div>
      </div>
    </div>

    <!-- REGISTRATION DETAILS -->
    <div class="info-section">
      <div class="section-header">
        <i class="bi bi-file-earmark-text-fill"></i>
        <h2>Registration Details</h2>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Registration Number</span>
          <span class="info-value reg-number">{{ vehicle.registration_number }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Registration Expiry</span>
          {% if vehicle.expiry_info.expiry_date %}
            <span class="info-value expiry-badge expiry-{{ vehicle.expiry_info.status }}">
              {{ vehicle.expiry_info.expiry_date|date:"F d, Y" }}
              {% if vehicle.expiry_info.days_remaining != None %}
                <span class="days-remaining">({{ vehicle.expiry_info.days_remaining }} days)</span>
              {% endif %}
            </span>
          {% else %}
            <span class="info-value">N/A</span>
          {% endif %}
        </div>
        <div class="info-item">
          <span class="info-label">License Plate</span>
          <span class="info-value plate-number">{{ vehicle.license_plate }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Date Registered</span>
          <span class="info-value">{{ vehicle.date_registered|date:"F d, Y" }}</span>
        </div>
      </div>
    </div>

    <!-- DOCUMENTATION -->
    <div class="info-section full-width">
      <div class="section-header">
        <i class="bi bi-folder-fill"></i>
        <h2>Documentation</h2>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">CR Number</span>
          <span class="info-value doc-number">{{ vehicle.cr_number }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">OR Number</span>
          <span class="info-value doc-number">{{ vehicle.or_number }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">VIN Number</span>
          <span class="info-value doc-number">{{ vehicle.vin_number }}</span>
        </div>
      </div>
    </div>

    <!-- ASSIGNED DRIVER -->
    <div class="info-section full-width">
      <div class="section-header">
        <i class="bi bi-person-fill"></i>
        <h2>Assigned Driver</h2>
      </div>
      {% if vehicle.assigned_driver %}
        <div class="driver-card">
          <div class="driver-photo-section">
            {% if vehicle.assigned_driver.driver_photo %}
              <img src="{{ vehicle.assigned_driver.driver_photo.url }}" alt="{{ vehicle.assigned_driver.first_name }}" class="driver-photo">
            {% else %}
              <div class="driver-photo-placeholder">
                <i class="bi bi-person-circle"></i>
              </div>
            {% endif %}
          </div>
          <div class="driver-info-section">
            <div class="driver-name">
              {{ vehicle.assigned_driver.first_name }} 
              {% if vehicle.assigned_driver.middle_name %}{{ vehicle.assigned_driver.middle_name }}{% endif %} 
              {{ vehicle.assigned_driver.last_name }}
            </div>
            <div class="driver-id">{{ vehicle.assigned_driver.driver_id }}</div>
            <div class="driver-contact">
              <div class="contact-item">
                <i class="bi bi-telephone"></i>
                <span>{{ vehicle.assigned_driver.mobile_number|default:"N/A" }}</span>
              </div>
              <div class="contact-item">
                <i class="bi bi-envelope"></i>
                <span>{{ vehicle.assigned_driver.email|default:"N/A" }}</span>
              </div>
            </div>
          </div>
          <div class="driver-actions">
            <a href="{% url 'vehicles:driver_detail' vehicle.assigned_driver.id %}" class="btn-view-driver">
              <i class="bi bi-eye"></i>
              View Profile
            </a>
          </div>
        </div>
      {% else %}
        <div class="empty-driver">
          <i class="bi bi-person-x"></i>
          <p>No driver assigned to this vehicle</p>
        </div>
      {% endif %}
    </div>

    <!-- ROUTE INFORMATION -->
    {% if vehicle.route %}
    <div class="info-section full-width">
      <div class="section-header">
        <i class="bi bi-signpost-2-fill"></i>
        <h2>Route Information</h2>
      </div>
      <div class="route-card">
        <div class="route-name">{{ vehicle.route.name }}</div>
        <div class="route-path">
          <span class="route-origin">{{ vehicle.route.origin }}</span>
          <i class="bi bi-arrow-right"></i>
          <span class="route-destination">{{ vehicle.route.destination }}</span>
        </div>
        <div class="route-fare">
          Base Fare: â‚±{{ vehicle.route.base_fare }}
        </div>
      </div>
    </div>
    {% endif %}

  </div>
  <!-- End View Mode -->

  </div>
  <!-- End Content Grid -->

</div>

<!-- DELETE CONFIRMATION MODAL -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <h3>Confirm Deletion</h3>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete <strong>{{ vehicle.vehicle_name }}</strong> ({{ vehicle.license_plate }})?</p>
      <p class="warning-text">This action cannot be undone. All associated data will be permanently removed.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cancel" id="btnCancelDelete">Cancel</button>
      <button type="button" class="btn-confirm-delete" id="btnConfirmDelete">
        <i class="bi bi-trash"></i>
        Delete Vehicle
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const deleteModal = document.getElementById('deleteModal');
  const btnDelete = document.getElementById('btnDeleteVehicle');
  const btnToggleEdit = document.getElementById('btnToggleEdit');
  const btnCancelEdit = document.getElementById('btnCancelEdit');
  const btnCancelDelete = document.getElementById('btnCancelDelete');
  const btnConfirmDelete = document.getElementById('btnConfirmDelete');
  const editForm = document.getElementById('vehicleEditForm');
  const viewMode = document.getElementById('vehicleViewMode');
  const editButtonText = document.getElementById('editButtonText');

  let isEditMode = false;

  // Toggle edit mode
  if (btnToggleEdit) {
    btnToggleEdit.addEventListener('click', function() {
      isEditMode = !isEditMode;
      
      if (isEditMode) {
        // Switch to edit mode
        viewMode.style.display = 'none';
        editForm.style.display = 'block';
        editButtonText.textContent = 'Cancel Edit';
        btnToggleEdit.classList.remove('btn-edit');
        btnToggleEdit.classList.add('btn-cancel');
      } else {
        // Switch to view mode
        viewMode.style.display = 'grid';
        editForm.style.display = 'none';
        editButtonText.textContent = 'Edit Vehicle';
        btnToggleEdit.classList.remove('btn-cancel');
        btnToggleEdit.classList.add('btn-edit');
      }
    });
  }

  // Cancel edit
  if (btnCancelEdit) {
    btnCancelEdit.addEventListener('click', function() {
      viewMode.style.display = 'grid';
      editForm.style.display = 'none';
      editButtonText.textContent = 'Edit Vehicle';
      btnToggleEdit.classList.remove('btn-cancel');
      btnToggleEdit.classList.add('btn-edit');
      isEditMode = false;
    });
  }

  // Handle form submission
  if (editForm) {
    editForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const submitBtn = editForm.querySelector('[type="submit"]');
      if (submitBtn) submitBtn.disabled = true;

      const formData = new FormData(editForm);

      fetch(editForm.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Reload page to show updated data
          window.location.reload();
        } else {
          alert(data.message || 'Failed to update vehicle');
          if (submitBtn) submitBtn.disabled = false;
        }
      })
      .catch(err => {
        console.error('Submit error:', err);
        alert('Error updating vehicle');
        if (submitBtn) submitBtn.disabled = false;
      });
    });
  }

  // Open delete modal
  if (btnDelete) {
    btnDelete.addEventListener('click', function() {
      deleteModal.style.display = 'flex';
    });
  }

  // Cancel delete
  if (btnCancelDelete) {
    btnCancelDelete.addEventListener('click', function() {
      deleteModal.style.display = 'none';
    });
  }

  // Confirm delete
  if (btnConfirmDelete) {
    btnConfirmDelete.addEventListener('click', function() {
      btnConfirmDelete.disabled = true;
      
      fetch("{% url 'vehicles:delete_vehicle' vehicle.id %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          window.location.href = "{% url 'vehicles:registered_vehicles' %}";
        } else {
          alert(data.message || 'Failed to delete vehicle');
          btnConfirmDelete.disabled = false;
        }
      })
      .catch(err => {
        console.error('Delete error:', err);
        alert('Error deleting vehicle');
        btnConfirmDelete.disabled = false;
      });
    });
  }

  // Close modal on backdrop click
  if (deleteModal) {
    deleteModal.addEventListener('click', function(e) {
      if (e.target === deleteModal) {
        deleteModal.style.display = 'none';
      }
    });
  }
});
</script>

{% endblock %}
