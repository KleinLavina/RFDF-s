{% extends "base.html" %}
{% load static %}

{% block title %}QR Entry & Departure | RDFS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/terminal/qr-entry.css' %}?v=1.0">
{% endblock %}

{% block content %}

<div class="qr-entry-container">

  <!-- HEADER -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="bi bi-qr-code-scan"></i>
        QR Entry & Departure Scanner
      </h1>
      <p class="page-subtitle">
        Scan vehicle QR codes to automatically record terminal entry or departure
      </p>
    </div>
    <a href="{% if user.role == 'admin' %}{% url 'accounts:admin_dashboard' %}{% else %}{% url 'accounts:staff_dashboard' %}{% endif %}"
       class="btn-back">
      <i class="bi bi-arrow-left-circle"></i>
      Dashboard
    </a>
  </div>

  <!-- INFO CARDS -->
  <div class="info-cards-grid">
    <div class="info-card">
      <div class="info-card-icon">
        <i class="bi bi-cash-coin"></i>
      </div>
      <div class="info-card-content">
        <div class="info-card-label">Terminal Fee</div>
        <div class="info-card-value">₱{{ terminal_fee }}</div>
      </div>
    </div>
    <div class="info-card">
      <div class="info-card-icon">
        <i class="bi bi-wallet2"></i>
      </div>
      <div class="info-card-content">
        <div class="info-card-label">Minimum Deposit</div>
        <div class="info-card-value">₱{{ min_deposit }}</div>
      </div>
    </div>
    <div class="info-card">
      <div class="info-card-icon">
        <i class="bi bi-clock-history"></i>
      </div>
      <div class="info-card-content">
        <div class="info-card-label">Entry Cooldown</div>
        <div class="info-card-value">{{ cooldown }} min</div>
      </div>
    </div>
  </div>

  <!-- STATUS LEGEND -->
  <div class="status-legend">
    <div class="legend-title">
      <i class="bi bi-info-circle"></i>
      System Status Indicators
    </div>
    <div class="legend-items">
      <div class="legend-item">
        <span class="legend-badge badge-entry">
          <i class="bi bi-box-arrow-in-right"></i>
          Entry
        </span>
        <span class="legend-text">Vehicle entering terminal</span>
      </div>
      <div class="legend-item">
        <span class="legend-badge badge-departure">
          <i class="bi bi-box-arrow-right"></i>
          Departure
        </span>
        <span class="legend-text">Vehicle leaving terminal</span>
      </div>
      <div class="legend-item">
        <span class="legend-badge badge-queued">
          <i class="bi bi-hourglass-split"></i>
          Queued
        </span>
        <span class="legend-text">Already in queue</span>
      </div>
    </div>
  </div>

  <!-- MAIN SCANNER CARD -->
  <div class="scanner-card">
    <div class="scanner-card-header">
      <div class="scanner-header-content">
        <i class="bi bi-camera-video"></i>
        <div>
          <h2 class="scanner-title">QR Code Scanner</h2>
          <p class="scanner-subtitle">Position QR code within the frame</p>
        </div>
      </div>
      <div class="scanner-status" id="scannerStatus">
        <span class="status-dot"></span>
        <span class="status-text">Ready</span>
      </div>
    </div>

    <div class="scanner-card-body">

      <!-- START CAMERA SECTION -->
      <div id="startCameraSection" class="start-camera-section">
        <div class="camera-icon-large">
          <i class="bi bi-camera-fill"></i>
        </div>
        <h3 class="start-camera-title">Activate Camera to Begin</h3>
        <p class="start-camera-text">
          Click the button below to start the QR code scanner
        </p>
        <button id="startCameraBtn" class="btn-start-camera">
          <i class="bi bi-camera-video-fill"></i>
          Start Camera
        </button>
      </div>

      <!-- QR SCANNER -->
      <div id="qrScannerWrap" class="qr-scanner-wrap">
        <div id="rdfsQrReader" class="qr-reader"></div>
        
        <!-- RESET COOLDOWN OVERLAY -->
        <div id="rdfsQrResetCooldown" class="reset-cooldown-overlay">
          <div class="reset-cooldown-content">
            <i class="bi bi-hourglass-split"></i>
            <h4>Already Queued</h4>
            <p>Scan again after cooldown to reset your position without additional fee</p>
          </div>
        </div>
      </div>

      <!-- FEEDBACK AREA -->
      <div id="feedbackArea" class="feedback-area">
        <!-- Status messages will appear here -->
      </div>

      <!-- RESET HINT -->
      <div id="rdfsQrResetHint" class="reset-hint">
        <i class="bi bi-info-circle-fill"></i>
        <span>You're already in queue. Scan again to reset your position without another fee.</span>
      </div>

    </div>
  </div>

  <!-- CSRF -->
  <form style="display:none;">{% csrf_token %}</form>

</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="{% static 'js/terminal/qr-entry.js' %}?v=1.0"></script>

{% endblock %}
