{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Terminal TV Display | RDFS</title>

  <link rel="icon" type="image/png" href="{% static 'img/RDFS-Logo.png' %}">
  <link rel="stylesheet" href="{% static 'styles/terminal/01.css' %}">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>

<!-- HEADER -->
<div class="tv-header">
  <h2><i class="fa-solid fa-tv me-2"></i> Terminal Queue Board</h2>

  <div class="tv-sub">
    {% if selected_route != "All Routes" %}
      <i class="fa-solid fa-road me-1"></i> {{ selected_route }} Display
    {% else %}
      <i class="fa-solid fa-earth-americas me-1"></i> All Routes Display
    {% endif %}
  </div>

  <div id="live-clock" class="tv-clock">
    <i class="fa-solid fa-clock-rotate-left me-2"></i>
    <span id="current-date"></span> | <span id="current-time"></span>
  </div>

  <a href="{% url 'accounts:staff_dashboard' %}" class="tv-btn back">
    <i class="fa-solid fa-circle-arrow-left me-1"></i> Dashboard
  </a>

  <button id="fullscreenBtn" class="tv-btn full">
    <i class="fa-solid fa-expand me-1"></i> Fullscreen
  </button>
</div>

<!-- ROUTE CONTAINER -->
<div class="container-fluid px-5">

  <!-- CONTAINER HEADER -->
  <div class="container-header">
    <div class="container-title">
      <i class="fa-solid fa-diagram-project me-2"></i>
      Active Routes Overview
    </div>

    <div class="route-filter">
      <label for="routeSelector">
        <i class="fa-solid fa-filter me-1"></i> Filter Route
      </label>
      <select id="routeSelector" onchange="filterRoute(this.value)">
        <option value="">All Routes</option>
        {% for route in all_routes %}
          <option value="{{ route.name|slugify }}"
                  {% if route.name == selected_route %}selected{% endif %}>
            {{ route.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- ROUTES -->
  <div id="route-container">
    {% if grouped_routes %}
      {% for route_name, vehicles in grouped_routes.items %}
      <div class="route-section" data-route="{{ route_name|slugify }}">
        <div class="route-header">
          <div>
            <i class="fa-solid fa-location-dot me-2"></i>
            {{ route_name }}
          </div>
          <div class="route-count">
            <i class="fa-solid fa-bus"></i>
            {{ vehicles|length }} Active
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <thead>
              <tr>
                <th><i class="fa-solid fa-door-open"></i> Entry Time</th>
                <th><i class="fa-solid fa-van-shuttle"></i> Vehicle</th>
                <th><i class="fa-solid fa-user-tie"></i> Driver</th>
                <th><i class="fa-solid fa-clock-four"></i> Departure Time</th>
                <th><i class="fa-solid fa-hourglass-half"></i> Status</th>
              </tr>
            </thead>
            <tbody>
              {% for v in vehicles %}
              <tr data-departure="{{ v.departure_timestamp }}" 
                  data-has-departed="{{ v.has_departed|yesno:'true,false' }}"
                  data-plate="{{ v.plate }}"
                  data-departure-time="{{ v.departure_time }}"
                  data-actual-departed="{{ v.actual_departed_at|default:'' }}">
                <td>
                  <span class="entry-time">
                    <i class="fa-solid fa-calendar-check me-1"></i>{{ v.entry_time }}
                  </span>
                </td>
                <td>
                  <span class="vehicle-plate">
                    <i class="fa-solid fa-id-card me-1"></i>{{ v.plate }}
                  </span>
                </td>
                <td class="driver-info">
                  <i class="fa-solid fa-id-badge me-2"></i>{{ v.driver }}
                </td>
                <td>
                  <div class="countdown-container">
                    {% if v.has_departed %}
                      <!-- Already departed -->
                      <span class="departure-time-display departed">
                        <i class="fa-solid fa-calendar-xmark me-1"></i>
                        {{ v.actual_departed_at }}
                      </span>
                    {% else %}
                      <!-- Still in terminal -->
                      <span class="departure-time-display">
                        <i class="fa-solid fa-calendar-days me-1"></i>
                        {{ v.departure_time }}
                      </span>
                    {% endif %}
                    
                    <div class="progress-container">
                      <div class="progress">
                        {% if v.has_departed %}
                          <div class="progress-bar glow" style="width:100%; background:linear-gradient(90deg, var(--dark-blue), var(--dark-blue-hover));"></div>
                        {% else %}
                          <div class="progress-bar" style="width:0%"></div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  {% if v.has_departed %}
                    <!-- Already departed - show static state -->
                    <span class="status-badge status-departed">
                      <i class="fa-solid fa-circle-check"></i>
                      <span class="countdown-text">DEPARTED</span>
                    </span>
                  {% else %}
                    <!-- Still in terminal - show countdown -->
                    <span class="status-badge status-boarding countdown-element">
                      <i class="fa-solid fa-clock"></i>
                      <span class="countdown-text">Loading...</span>
                    </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-secondary text-center">
        <i class="fa-solid fa-circle-info me-2"></i> No active vehicles in terminal.
      </div>
    {% endif %}
  </div>
</div>

<script>
/* ===================================================
   CLOCK UPDATE - SMOOTH REAL-TIME
=================================================== */
function updateDateTime() {
  const now = new Date();
  
  const dateOptions = { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  };
  const timeOptions = { 
    hour12: true, 
    hour: 'numeric', 
    minute: '2-digit', 
    second: '2-digit',
    timeZoneName: 'short' 
  };
  
  document.getElementById('current-date').textContent = 
    now.toLocaleDateString('en-US', dateOptions);
  document.getElementById('current-time').textContent = 
    now.toLocaleTimeString('en-US', timeOptions);
}

/* ===================================================
   ROUTE FILTER
=================================================== */
function filterRoute(slug){
  const base = window.location.origin + "{% url 'terminal:tv_display' %}";
  window.location.href = slug ? base + slug + "/" : base;
}

/* ===================================================
   COUNTDOWN LOGIC - REAL-TIME SMOOTH UPDATES
=================================================== */
function updateAllCountdowns() {
  const now = new Date().getTime();
  const departureLimit = {{ stay_duration }} * 60 * 1000; // Convert minutes to milliseconds
  
  document.querySelectorAll(".countdown-element").forEach(badge => {
    const row = badge.closest('tr');
    
    // Skip if vehicle has already departed
    if (row.dataset.hasDeparted === 'true') {
      return;
    }
    
    const departureTime = new Date(row.dataset.departure).getTime();
    
    // Check if departure time is valid
    if (isNaN(departureTime)) {
      console.error('Invalid departure time:', row.dataset.departure);
      return;
    }
    
    const timeDiff = departureTime - now;
    const progressBar = row.querySelector(".progress-bar");
    
    if (timeDiff <= 0) {
      // TIME EXPIRED
      badge.className = "status-badge status-departed";
      badge.innerHTML = '<i class="fa-solid fa-hourglass-end"></i> <span class="countdown-text">TIME EXPIRED</span>';
      
      if (progressBar) {
        progressBar.style.width = "100%";
        progressBar.style.background = "linear-gradient(90deg, var(--danger), #c0392b)";
        progressBar.classList.add("glow");
      }
      
    } else if (timeDiff <= departureLimit) {
      // COUNTDOWN ACTIVE - REAL-TIME SMOOTH UPDATES
      const totalMinutes = Math.floor(timeDiff / 60000);
      const seconds = Math.floor((timeDiff % 60000) / 1000);
      
      const minsStr = totalMinutes.toString().padStart(2, '0');
      const secsStr = seconds.toString().padStart(2, '0');
      
      badge.className = "status-badge status-countdown";
      badge.innerHTML = `<i class="fa-solid fa-stopwatch"></i> <span class="countdown-text countdown-timer">${minsStr}:${secsStr}</span>`;
      
      // Progress calculation for smooth animation
      if (progressBar) {
        const progressPercent = 100 - (timeDiff / departureLimit) * 100;
        const currentWidth = parseFloat(progressBar.style.width) || 0;
        
        // Smooth transition for progress bar
        const targetWidth = Math.min(100, Math.max(0, progressPercent));
        if (Math.abs(currentWidth - targetWidth) > 1) {
          progressBar.style.width = `${targetWidth}%`;
          progressBar.style.transition = 'width 0.5s ease';
        } else {
          progressBar.style.width = `${targetWidth}%`;
        }
        
        // Color gradient based on urgency
        if (progressPercent > 75) {
          progressBar.style.background = "linear-gradient(90deg, #e74c3c, #c0392b)";
        } else if (progressPercent > 50) {
          progressBar.style.background = "linear-gradient(90deg, var(--soft-coral), #e67e73)";
        } else if (progressPercent > 25) {
          progressBar.style.background = "linear-gradient(90deg, var(--soft-peach), var(--soft-coral))";
        } else {
          progressBar.style.background = "linear-gradient(90deg, var(--muted-light-blue), var(--muted-light-blue-dark))";
        }
        
        // Add pulse animation when under 5 minutes
        if (timeDiff < 5 * 60 * 1000) { // 5 minutes
          if (!progressBar.classList.contains('pulse')) {
            progressBar.classList.add('pulse');
          }
        } else {
          progressBar.classList.remove('pulse');
        }
        
        progressBar.classList.remove("glow");
      }
      
    } else {
      // BOARDING (still have plenty of time)
      badge.className = "status-badge status-boarding";
      badge.innerHTML = '<i class="fa-solid fa-users"></i> <span class="countdown-text">BOARDING</span>';
      
      if (progressBar) {
        progressBar.style.width = "0%";
        progressBar.classList.remove("glow", "pulse");
      }
    }
  });
  
  // Schedule next update using requestAnimationFrame for smooth 60fps updates
  requestAnimationFrame(updateAllCountdowns);
}

/* ===================================================
   AUTO REFRESH - NON-BLOCKING
=================================================== */
let refreshInProgress = false;
let lastRefresh = Date.now();

function refreshContent() {
  // Don't refresh if already refreshing or less than 30 seconds since last refresh
  if (refreshInProgress || (Date.now() - lastRefresh < 30000)) {
    return;
  }
  
  refreshInProgress = true;
  
  fetch(location.href, {
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.text())
  .then(html => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const newRouteContainer = doc.getElementById('route-container');
    
    if (!newRouteContainer) {
      refreshInProgress = false;
      return;
    }
    
    // Compare current and new content
    const currentContent = document.getElementById('route-container').innerHTML;
    const newContent = newRouteContainer.innerHTML;
    
    // Only update if content actually changed
    if (currentContent !== newContent) {
      // Smooth transition
      const routeContainer = document.getElementById('route-container');
      routeContainer.style.opacity = '0.7';
      routeContainer.style.transition = 'opacity 0.3s ease';
      
      setTimeout(() => {
        routeContainer.innerHTML = newContent;
        routeContainer.style.opacity = '1';
        lastRefresh = Date.now();
        refreshInProgress = false;
      }, 300);
    } else {
      refreshInProgress = false;
    }
  })
  .catch(error => {
    console.error('Refresh failed:', error);
    refreshInProgress = false;
  });
}

/* ===================================================
   FULLSCREEN TOGGLE
=================================================== */
const fullscreenBtn = document.getElementById('fullscreenBtn');
fullscreenBtn.onclick = () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    fullscreenBtn.innerHTML = '<i class="fa-solid fa-compress me-1"></i> Exit Fullscreen';
  } else {
    document.exitFullscreen();
    fullscreenBtn.innerHTML = '<i class="fa-solid fa-expand me-1"></i> Fullscreen';
  }
};

/* ===================================================
   INITIALIZE ON PAGE LOAD
=================================================== */
document.addEventListener('DOMContentLoaded', () => {
  // Start clock with smooth updates
  updateDateTime();
  setInterval(updateDateTime, 1000);
  
  // Start countdown with smooth real-time animation
  updateAllCountdowns(); // Uses requestAnimationFrame for smooth updates
  
  // Background refresh every 30 seconds
  setInterval(refreshContent, 30000);
  
  // Smooth page load
  document.body.style.opacity = '0';
  document.body.style.transition = 'opacity 0.5s ease';
  setTimeout(() => {
    document.body.style.opacity = '1';
  }, 100);
});

/* ===================================================
   ADD CSS FOR PULSE ANIMATION
=================================================== */
const style = document.createElement('style');
style.textContent = `
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.pulse {
  animation: pulse 1s infinite;
}
`;
document.head.appendChild(style);
</script>

</body>
</html>