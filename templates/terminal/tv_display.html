{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Terminal TV Display | RDFS</title>

  <link rel="icon" type="image/png" href="{% static 'img/RDFS-Logo.png' %}">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
  /* =====================================================
     RDFS â€“ TERMINAL TV DISPLAY - UPDATED COLOR SCHEME
  ===================================================== */
  :root{
    --rdfs-blue:#112666;
    --rdfs-blue-dark:#0c1c4a;
    --rdfs-accent:#2563eb;
    --rdfs-soft:#e8f4fd;

    /* NEW COLOR PALETTE */
    --muted-light-blue:#a8d5e2;
    --muted-light-blue-dark:#7ab8d3;
    --dark-blue:#1e3a5f;
    --dark-blue-hover:#2d5278;
    --muted-light-green:#b8dac3;
    --muted-green:#8bc99a;
    --soft-cream:#f4f1e8;
    --warm-gray:#e5e0d8;
    --soft-coral:#f6a192;
    --soft-peach:#ffd5b5;

    --text:#2c3e50;
    --muted:#64748b;

    --gray-100:#f7fafc;
    --gray-200:#edf2f7;
    --gray-300:#e2e8f0;

    --danger:#e74c3c;
    --warning:#f39c12;
    --success:#27ae60;

    --shadow-sm:0 1px 3px rgba(0,0,0,.08);
    --shadow-md:0 8px 18px rgba(0,0,0,.12);
  }

  body{
    background:linear-gradient(180deg,#ffffff 0%,#eef4ff 100%);
    font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
    font-size:1.35rem;
    color:var(--text);
    overflow-x:hidden;
  }

  /* HEADER - KEEP EXISTING */
  .tv-header{
    background:linear-gradient(135deg,var(--rdfs-blue),var(--rdfs-accent));
    color:#fff;
    padding:1.5rem 2rem;
    box-shadow:var(--shadow-md);
    text-align:center;
    position:relative;
    border-bottom:4px solid rgba(255,255,255,.1);
  }

  .tv-header h2{
    font-weight:800;
    font-size:2.2rem;
    margin-bottom:.25rem;
    letter-spacing:-0.5px;
  }

  .tv-sub{
    font-size:1.2rem;
    color:#e8f4fd;
    font-weight:500;
  }

  .tv-clock{
    font-size:1.2rem;
    font-weight:600;
    background:rgba(255,255,255,.15);
    padding:.4rem 1rem;
    border-radius:12px;
    display:inline-block;
    margin-top:.5rem;
    font-family:'JetBrains Mono',monospace;
  }

  /* HEADER BUTTONS - KEEP EXISTING */
  .tv-btn{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    padding:.6rem 1.5rem;
    font-size:1rem;
    font-weight:700;
    border-radius:12px;
    border:2px solid rgba(255,255,255,.3);
    background:rgba(255,255,255,.15);
    color:#fff;
    box-shadow:var(--shadow-sm);
    transition:.3s ease;
    text-decoration:none;
    backdrop-filter:blur(10px);
  }
  .tv-btn:hover{
    background:rgba(255,255,255,.25);
    border-color:rgba(255,255,255,.5);
    transform:translateY(-50%) scale(1.05);
  }
  .tv-btn.back{ left:25px; }
  .tv-btn.full{ right:25px; }

  /* CONTAINER HEADER - KEEP EXISTING */
  .container-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin:1.5rem 0 .5rem;
    padding:1rem;
    background:#fff;
    border-radius:16px;
    box-shadow:var(--shadow-sm);
  }

  .container-title{
    font-weight:800;
    font-size:1.6rem;
    color:var(--rdfs-blue-dark);
  }

  /* ROUTE FILTER - KEEP EXISTING */
  .route-filter{
    display:flex;
    align-items:center;
    gap:.75rem;
    background:var(--gray-100);
    padding:.5rem 1rem;
    border-radius:12px;
  }

  .route-filter label{
    font-size:.95rem;
    font-weight:600;
    color:var(--rdfs-blue);
    white-space:nowrap;
  }

  .route-filter select{
    width:280px;
    height:48px;
    font-size:1rem;
    border-radius:12px;
    border:2px solid var(--rdfs-accent);
    padding:0 1.25rem;
    font-weight:600;
    background:#fff;
    color:var(--rdfs-blue);
    transition:.2s ease;
  }
  .route-filter select:focus{
    border-color:var(--rdfs-blue);
    box-shadow:0 0 0 3px rgba(37,99,235,.2);
    outline:none;
  }

  /* ROUTE SECTION - UPDATED COLORS */
  .route-section{
    border-radius:18px;
    padding:1.5rem;
    margin-bottom:2rem;
    box-shadow:var(--shadow-md);
    border:2px solid var(--muted-light-blue);
    background:linear-gradient(135deg, var(--soft-cream) 0%, #ffffff 100%);
    transition:transform .3s ease, box-shadow .3s ease;
  }
  .route-section:hover{
    transform:translateY(-4px);
    box-shadow:0 12px 24px rgba(0,0,0,.15);
  }

  .route-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:1.6rem;
    font-weight:800;
    padding:1rem 1.5rem;
    border-radius:14px;
    margin-bottom:1.5rem;
    color:#fff;
    background:linear-gradient(135deg, var(--dark-blue) 0%, var(--dark-blue-hover) 100%);
    border-left:6px solid var(--muted-light-green);
    box-shadow:var(--shadow-sm);
  }

  .route-count{
    font-size:1rem;
    font-weight:600;
    color:var(--dark-blue);
    background:var(--muted-light-green);
    padding:.4rem 1rem;
    border-radius:20px;
    display:flex;
    align-items:center;
    gap:.5rem;
  }

  /* TABLE - UPDATED DESIGN */
  table{
    background:#fff;
    border-radius:16px;
    overflow:hidden;
    font-size:1.25rem;
    border:2px solid var(--muted-light-blue);
  }

  thead th{
    background:linear-gradient(135deg, var(--dark-blue) 0%, #2d5278 100%);
    color:#fff;
    text-align:center;
    font-size:1.1rem;
    padding:1.2rem 1rem;
    border:none;
    font-weight:600;
    letter-spacing:.5px;
    border-bottom:3px solid var(--muted-light-blue);
  }
  thead th i{
    margin-right:.5rem;
    font-size:1.1em;
    color:var(--muted-light-green);
  }

  tbody td{
    text-align:center;
    vertical-align:middle;
    padding:1.5rem 1rem;
    font-weight:500;
    border:1px solid var(--warm-gray);
    background:#fff;
  }

  tbody tr{
    transition:all .3s ease;
    border-bottom:2px solid var(--warm-gray);
  }
  tbody tr:hover{
    background:linear-gradient(90deg, var(--soft-cream) 0%, #ffffff 100%);
    transform:scale(1.01);
    box-shadow:0 4px 12px rgba(0,0,0,.08);
  }

  /* VEHICLE INFO STYLING - UPDATED */
  .vehicle-plate{
    font-family:'JetBrains Mono',monospace;
    font-weight:700;
    font-size:1.35rem;
    color:var(--dark-blue);
    background:linear-gradient(135deg, var(--muted-light-blue) 0%, var(--muted-light-blue-dark) 100%);
    padding:.6rem 1.2rem;
    border-radius:10px;
    display:inline-block;
    border:2px solid var(--muted-light-blue-dark);
    box-shadow:var(--shadow-sm);
  }

  .driver-info{
    font-size:1.15rem;
    color:var(--text);
    font-weight:600;
  }
  .driver-info i{
    color:var(--dark-blue);
  }

  .entry-time{
    font-family:'JetBrains Mono',monospace;
    font-weight:600;
    color:var(--dark-blue);
    background:var(--soft-cream);
    padding:.5rem 1rem;
    border-radius:8px;
    display:inline-block;
    border:1px solid var(--warm-gray);
  }
  .entry-time i{
    color:var(--muted-green);
  }

  /* COUNTDOWN CONTAINER - NEW DESIGN */
  .countdown-container{
    min-width:280px;
    display:flex;
    flex-direction:column;
    gap:.5rem;
  }

  .departure-time-display{
    font-family:'JetBrains Mono',monospace;
    font-weight:600;
    font-size:1.2rem;
    color:var(--dark-blue);
    background:var(--soft-cream);
    padding:.5rem 1rem;
    border-radius:8px;
    display:inline-block;
    border:1px solid var(--warm-gray);
    text-align:center;
  }
  .departure-time-display i{
    color:var(--muted-green);
  }
  .departure-time-display.departed{
    background:linear-gradient(135deg, var(--dark-blue) 0%, var(--dark-blue-hover) 100%);
    color:#fff;
    border-color:var(--dark-blue);
  }
  .departure-time-display.departed i{
    color:var(--muted-light-blue);
  }

  /* STATUS BADGES - UPDATED COLORS */
  .status-badge{
    font-size:1.15rem;
    padding:.65rem 1.1rem;
    border-radius:12px;
    font-weight:700;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.6rem;
    min-width:200px;
    transition:all .3s ease;
    border:2px solid transparent;
    box-shadow:var(--shadow-sm);
  }

  .status-badge i{
    font-size:1.2em;
  }

  /* BOARDING STATE - Muted Light Green */
  .status-boarding{
    background:linear-gradient(135deg, var(--muted-light-green) 0%, var(--muted-green) 100%);
    color:var(--dark-blue);
    border-color:var(--muted-green);
  }

  /* COUNTDOWN STATE - Soft Peach/Coral */
  .status-countdown{
    background:linear-gradient(135deg, var(--soft-peach) 0%, var(--soft-coral) 100%);
    color:var(--dark-blue);
    border-color:var(--soft-coral);
    animation:pulse-warning 2s ease-in-out infinite;
  }

  /* DEPARTED STATE - Dark Blue */
  .status-departed{
    background:linear-gradient(135deg, var(--dark-blue) 0%, var(--dark-blue-hover) 100%);
    color:#fff;
    border-color:var(--muted-light-blue);
    animation:pulse-departed 1.5s ease-in-out infinite;
  }

  @keyframes pulse-warning{
    0%, 100%{
      box-shadow:0 0 0 0 rgba(246,161,146,.7);
    }
    50%{
      box-shadow:0 0 0 8px rgba(246,161,146,0);
    }
  }

  @keyframes pulse-departed{
    0%, 100%{
      transform:scale(1);
      box-shadow:0 0 15px rgba(30,58,95,.5);
    }
    50%{
      transform:scale(1.03);
      box-shadow:0 0 20px rgba(30,58,95,.8);
    }
  }

  /* PROGRESS BAR - UPDATED */
  .progress-container{
    margin-top:.5rem;
  }

  .progress{
    height:14px;
    border-radius:10px;
    background:var(--warm-gray);
    overflow:hidden;
    box-shadow:inset 0 2px 4px rgba(0,0,0,.1);
    border:1px solid var(--muted-light-blue);
  }

  .progress-bar{
    transition:width 1s linear, background .3s ease;
    border-radius:10px;
    position:relative;
    height:100%;
  }

  .progress-bar::after{
    content:'';
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:linear-gradient(90deg,
      transparent 0%,
      rgba(255,255,255,.4) 50%,
      transparent 100%);
    animation:shimmer 2s infinite;
  }

  @keyframes shimmer{
    0%{transform:translateX(-100%);}
    100%{transform:translateX(100%);}
  }

  .progress-bar.glow{
    box-shadow:0 0 15px 5px rgba(231,76,60,.6);
  }

  /* COUNTDOWN TIMER TEXT */
  .countdown-timer{
    font-family:'JetBrains Mono',monospace;
    font-size:1.3rem;
    font-weight:700;
    letter-spacing:1.5px;
  }

  /* ALERT STYLING */
  .alert{
    font-size:1.4rem;
    border-radius:16px;
    padding:1.5rem;
    border:2px solid var(--muted-light-blue);
    box-shadow:var(--shadow-sm);
    background:var(--soft-cream);
  }

  /* RESPONSIVE ADJUSTMENTS */
  @media (max-width:1200px){
    body{font-size:1.2rem;}
    .tv-header h2{font-size:1.8rem;}
    .route-header{font-size:1.4rem;}
    .status-badge{min-width:180px;}
  }

  @media (max-width:768px){
    .tv-btn{position:relative;top:0;transform:none;margin:.5rem;}
    .tv-header{padding:1rem;}
    .container-header{flex-direction:column;gap:1rem;}
    .route-filter{width:100%;}
    .route-filter select{width:100%;}
    .route-section{padding:1rem;}
  }
  </style>
</head>

<body>

<!-- HEADER - KEEP AS IS -->
<div class="tv-header">
  <h2><i class="fa-solid fa-tv me-2"></i> Terminal Queue Board</h2>

  <div class="tv-sub">
    {% if selected_route != "All Routes" %}
      <i class="fa-solid fa-road me-1"></i> {{ selected_route }} Display
    {% else %}
      <i class="fa-solid fa-earth-americas me-1"></i> All Routes Display
    {% endif %}
  </div>

  <div id="live-clock" class="tv-clock">
    <i class="fa-solid fa-clock-rotate-left me-2"></i>
    <span id="current-date"></span> | <span id="current-time"></span>
  </div>

  <a href="{% url 'accounts:staff_dashboard' %}" class="tv-btn back">
    <i class="fa-solid fa-circle-arrow-left me-1"></i> Dashboard
  </a>

  <button id="fullscreenBtn" class="tv-btn full">
    <i class="fa-solid fa-expand me-1"></i> Fullscreen
  </button>
</div>

<!-- ROUTE CONTAINER -->
<div class="container-fluid px-5">

  <!-- CONTAINER HEADER - KEEP AS IS -->
  <div class="container-header">
    <div class="container-title">
      <i class="fa-solid fa-diagram-project me-2"></i>
      Active Routes Overview
    </div>

    <div class="route-filter">
      <label for="routeSelector">
        <i class="fa-solid fa-filter me-1"></i> Filter Route
      </label>
      <select id="routeSelector" onchange="filterRoute(this.value)">
        <option value="">All Routes</option>
        {% for route in all_routes %}
          <option value="{{ route.name|slugify }}"
                  {% if route.name == selected_route %}selected{% endif %}>
            {{ route.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- ROUTES -->
  <div id="route-container">
    {% if grouped_routes %}
      {% for route_name, vehicles in grouped_routes.items %}
      <div class="route-section" data-route="{{ route_name|slugify }}">
        <div class="route-header">
          <div>
            <i class="fa-solid fa-location-dot me-2"></i>
            {{ route_name }}
          </div>
          <div class="route-count">
            <i class="fa-solid fa-bus"></i>
            {{ vehicles|length }} Active
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered align-middle mb-0">
            <thead>
              <tr>
                <th><i class="fa-solid fa-door-open"></i> Entry Time</th>
                <th><i class="fa-solid fa-van-shuttle"></i> Vehicle</th>
                <th><i class="fa-solid fa-user-tie"></i> Driver</th>
                <th><i class="fa-solid fa-clock-four"></i> Departure Time</th>
                <th><i class="fa-solid fa-hourglass-half"></i> Status</th>
              </tr>
            </thead>
            <tbody>
              {% for v in vehicles %}
              <tr data-departure="{{ v.departure_timestamp }}" 
                  data-has-departed="{{ v.has_departed|yesno:'true,false' }}">
                <td>
                  <span class="entry-time">
                    <i class="fa-solid fa-calendar-check me-1"></i>{{ v.entry_time }}
                  </span>
                </td>
                <td>
                  <span class="vehicle-plate">
                    <i class="fa-solid fa-id-card me-1"></i>{{ v.plate }}
                  </span>
                </td>
                <td class="driver-info">
                  <i class="fa-solid fa-id-badge me-2"></i>{{ v.driver }}
                </td>
                <td>
                  <div class="countdown-container">
                    {% if v.has_departed %}
                      <!-- Already departed -->
                      <span class="departure-time-display departed">
                        <i class="fa-solid fa-calendar-xmark me-1"></i>
                        {{ v.actual_departed_at }}
                      </span>
                    {% else %}
                      <!-- Still in terminal -->
                      <span class="departure-time-display">
                        <i class="fa-solid fa-calendar-days me-1"></i>
                        {{ v.departure_time }}
                      </span>
                    {% endif %}
                    
                    <div class="progress-container">
                      <div class="progress">
                        {% if v.has_departed %}
                          <div class="progress-bar glow" style="width:100%; background:linear-gradient(90deg, var(--dark-blue), var(--dark-blue-hover));"></div>
                        {% else %}
                          <div class="progress-bar" style="width:0%"></div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  {% if v.has_departed %}
                    <!-- Already departed - show static state -->
                    <span class="status-badge status-departed">
                      <i class="fa-solid fa-circle-check"></i>
                      <span class="countdown-text">DEPARTED</span>
                    </span>
                  {% else %}
                    <!-- Still in terminal - show countdown -->
                    <span class="status-badge status-boarding countdown-element"
                          data-seconds="{{ v.time_remaining_seconds }}"
                          data-expired="{{ v.is_expired|yesno:'true,false' }}">
                      <i class="fa-solid fa-clock"></i>
                      <span class="countdown-text">Loading...</span>
                    </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-secondary text-center">
        <i class="fa-solid fa-circle-info me-2"></i> No active vehicles in terminal.
      </div>
    {% endif %}
  </div>
</div>

<script>
/* CLOCK */
function updateDateTime() {
  const now = new Date();
  
  const dateOptions = { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  };
  const timeOptions = { 
    hour12: true, 
    hour: 'numeric', 
    minute: '2-digit', 
    second: '2-digit',
    timeZoneName: 'short' 
  };
  
  document.getElementById('current-date').textContent = 
    now.toLocaleDateString('en-US', dateOptions);
  document.getElementById('current-time').textContent = 
    now.toLocaleTimeString('en-US', timeOptions);
}

/* ROUTE FILTER */
function filterRoute(slug){
  const base = window.location.origin + "{% url 'terminal:tv_display' %}";
  window.location.href = slug ? base + slug + "/" : base;
}

/* COUNTDOWN LOGIC - UPDATED */
function updateCountdowns(){
  const now = Date.now();
  const departureLimit = {{ stay_duration }} * 60 * 1000; // Convert minutes to milliseconds
  
  document.querySelectorAll(".countdown-element").forEach(badge => {
    const row = badge.closest('tr');
    
    // Skip if vehicle has already departed (handled server-side)
    if (row.dataset.hasDeparted === 'true') {
      return;
    }
    
    const departureTime = new Date(row.dataset.departure).getTime();
    const timeDiff = departureTime - now;
    const progressBar = row.querySelector(".progress-bar");
    const countdownText = badge.querySelector(".countdown-text");
    
    if (timeDiff <= 0) {
      // TIME EXPIRED (but vehicle hasn't physically departed yet)
      badge.className = "status-badge status-departed";
      badge.innerHTML = '<i class="fa-solid fa-hourglass-end"></i> <span class="countdown-text">TIME EXPIRED</span>';
      
      progressBar.style.width = "100%";
      progressBar.style.background = "linear-gradient(90deg, var(--danger), #c0392b)";
      progressBar.classList.add("glow");
      
    } else if (timeDiff <= departureLimit) {
      // COUNTDOWN ACTIVE
      const totalMinutes = Math.floor(timeDiff / 60000);
      const seconds = Math.floor((timeDiff % 60000) / 1000);
      
      const minsStr = totalMinutes.toString().padStart(2, '0');
      const secsStr = seconds.toString().padStart(2, '0');
      
      badge.className = "status-badge status-countdown";
      badge.innerHTML = `<i class="fa-solid fa-stopwatch"></i> <span class="countdown-text">${minsStr}:${secsStr}</span>`;
      
      // Progress calculation
      const progressPercent = 100 - (timeDiff / departureLimit) * 100;
      progressBar.style.width = `${progressPercent}%`;
      
      // Color gradient based on urgency
      if (progressPercent > 75) {
        progressBar.style.background = "linear-gradient(90deg, #e74c3c, #c0392b)";
      } else if (progressPercent > 50) {
        progressBar.style.background = "linear-gradient(90deg, var(--soft-coral), #e67e73)";
      } else if (progressPercent > 25) {
        progressBar.style.background = "linear-gradient(90deg, var(--soft-peach), var(--soft-coral))";
      } else {
        progressBar.style.background = "linear-gradient(90deg, var(--muted-light-blue), var(--muted-light-blue-dark))";
      }
      progressBar.classList.remove("glow");
      
    } else {
      // BOARDING
      badge.className = "status-badge status-boarding";
      badge.innerHTML = '<i class="fa-solid fa-users"></i> <span class="countdown-text">BOARDING</span>';
      
      progressBar.style.width = "0%";
      progressBar.classList.remove("glow");
    }
  });
}

/* AUTO REFRESH */
let refreshInProgress = false;

function refreshContent() {
  if (refreshInProgress) return;
  
  refreshInProgress = true;
  
  const routeContainer = document.getElementById('route-container');
  routeContainer.style.opacity = '0.7';
  routeContainer.style.transition = 'opacity 0.3s ease';
  
  fetch(location.href, {
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.text())
  .then(html => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const newContent = doc.getElementById('route-container').innerHTML;
    
    routeContainer.innerHTML = newContent;
    routeContainer.style.opacity = '1';
    
    updateCountdowns();
    refreshInProgress = false;
  })
  .catch(error => {
    console.error('Refresh failed:', error);
    routeContainer.style.opacity = '1';
    refreshInProgress = false;
  });
}

/* FULLSCREEN */
const fullscreenBtn = document.getElementById('fullscreenBtn');
fullscreenBtn.onclick = () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    fullscreenBtn.innerHTML = '<i class="fa-solid fa-compress me-1"></i> Exit Fullscreen';
  } else {
    document.exitFullscreen();
    fullscreenBtn.innerHTML = '<i class="fa-solid fa-expand me-1"></i> Fullscreen';
  }
};

/* INITIALIZE */
document.addEventListener('DOMContentLoaded', () => {
  updateDateTime();
  setInterval(updateDateTime, 1000);
  
  updateCountdowns();
  setInterval(updateCountdowns, 1000);
  
  setInterval(refreshContent, 30000);
  
  document.body.style.opacity = '0';
  document.body.style.transition = 'opacity 0.5s ease';
  setTimeout(() => {
    document.body.style.opacity = '1';
  }, 100);
});
</script>

</body>
</html>