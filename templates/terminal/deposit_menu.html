{% extends "base.html" %}
{% load static %}

{% block title %}Deposit Menu | RDFS{% endblock %}

{% block content %}

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" href="{% static 'styles/deposit_menu.css' %}" />
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />

<div class="p-4 rdfs-deposit-scope rdfs-deposit-container">

  <!-- HEADER -->
  <div class="rdfs-deposit-header">
    <div>
      <h3 class="rdfs-deposit-title mb-1">
        <i class="fa-solid fa-wallet me-2"></i>
        Deposit Menu
      </h3>
      <span class="rdfs-deposit-note">
        Minimum required before entry:
        <strong>‚Ç±{{ min_deposit }}</strong>
      </span>
    </div>

    <a href="{% url 'accounts:staff_dashboard' %}"
       class="btn rdfs-deposit-back">
      <i class="fa-solid fa-arrow-left me-1"></i>
      Back to Dashboard
    </a>
  </div>
  <div id="rdfsActionToast" class="rdfs-action-toast" role="status" aria-live="polite">
    <i class="fa-solid fa-circle-check"></i>
    <span id="rdfsActionToastText"></span>
  </div>

  {% if role != 'admin' %}
  <!-- ================= STAFF VIEW ================= -->
  <div class="card border-0 mb-4 rdfs-deposit-card">
    <div class="card-header rdfs-deposit-header-dark fw-semibold">
      <i class="fa-solid fa-circle-plus me-1"></i>
      Add Deposit
    </div>

    <div class="card-body">
      <form method="POST" action="{% url 'terminal:deposit_menu' %}">
        {% csrf_token %}
        <div class="row g-3">

          <div class="col-md-5">
            <label class="form-label fw-semibold">Select Vehicle</label>
            <select id="rdfsVehicleSelect"
                    name="vehicle_id"
                    class="form-select"
                    required>
              <option value="">-- Choose Vehicle --</option>
              {% for driver in drivers %}
                {% for vehicle in driver.vehicles.all %}
                  <option value="{{ vehicle.id }}">
                    {{ vehicle.license_plate }} ‚Äî {{ driver.last_name }},
                    {{ driver.first_name }}
                  </option>
                {% endfor %}
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold">Deposit Amount (‚Ç±)</label>
            <input type="number"
                   name="amount"
                   min="1"
                   step="0.01"
                   class="form-control"
                   required
                   placeholder="Enter amount">
          </div>

          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fa-solid fa-hand-holding-dollar me-1"></i>
              Add Deposit
            </button>
          </div>

        </div>
      </form>

      <div id="rdfsWalletInfo"
           class="mt-2 text-muted small fw-semibold"></div>
    </div>
  </div>
  {% endif %}

  <div class="card border-0 mb-4 rdfs-deposit-card">
    <div class="card-header rdfs-deposit-header-dark fw-semibold d-flex justify-content-between align-items-center">
      <div>
        <i class="fa-solid fa-clock me-2"></i>
        Deposit History
      </div>
      <span class="badge bg-light text-dark rdfs-deposit-today">
        {% if start_date or end_date %}
          Showing: {{ start_date }}{% if end_date %} ‚Äî {{ end_date }}{% endif %}
        {% else %}
          Showing recent deposits
        {% endif %}
        ‚Ä¢
        {% if history_sort == 'largest' %}
          Largest first
        {% elif history_sort == 'smallest' %}
          Smallest first
        {% elif history_sort == 'all' %}
          All deposits
        {% else %}
          Newest first
        {% endif %}
      </span>
    </div>

    <div class="card-body">
      {% if role == 'admin' %}
      <form method="get" class="row g-3 mb-3">
        <input type="hidden" name="history_sort" value="{{ history_sort }}">

        <div class="col-md-5">
          <label class="form-label fw-semibold">Start Date</label>
          <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
        </div>

        <div class="col-md-5">
          <label class="form-label fw-semibold">End Date</label>
          <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
        </div>

        <div class="col-md-2 d-flex align-items-end justify-content-end">
          <button type="submit" class="btn btn-primary w-auto">
            <i class="fa-solid fa-filter me-1"></i>
            Apply Filter
          </button>
        </div>
      </form>
      {% endif %}

      <form method="get" class="row g-3 mb-4 align-items-end">
        <input type="hidden" name="start_date" value="{{ start_date }}">
        <input type="hidden" name="end_date" value="{{ end_date }}">
        <input type="hidden" name="vehicle_plate" value="{{ vehicle_plate }}">

        <div class="col-md-6">
          <label class="form-label fw-semibold">Deposit Order</label>
          <select name="history_sort" class="form-select">
            <option value="newest" {% if history_sort == 'newest' %}selected{% endif %}>
              Newest deposits
            </option>
            <option value="largest" {% if history_sort == 'largest' %}selected{% endif %}>
              Largest deposits
            </option>
            <option value="smallest" {% if history_sort == 'smallest' %}selected{% endif %}>
              Smallest deposits
            </option>
            <option value="all" {% if history_sort == 'all' %}selected{% endif %}>
              All deposits
            </option>
          </select>
        </div>

        <div class="col-md-2 d-flex align-items-end justify-content-end">
          <button type="submit" class="btn btn-outline-secondary w-auto">
            <i class="fa-solid fa-arrow-down-up me-1"></i>
            Apply
          </button>
        </div>
      </form>

      <div class="table-responsive">
        <table id="rdfsDepositTable"
               class="table table-striped table-hover align-middle rdfs-deposit-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Reference</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Payment Method</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for deposit in history_deposits %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td><strong>{{ deposit.reference_number }}</strong></td>
              <td>‚Ç±{{ deposit.amount|floatformat:2 }}</td>
              <td>{{ deposit.status|capfirst }}</td>
              <td>{{ deposit.payment_method|capfirst }}</td>
              <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                No deposits found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>



</div>

<!-- ================= JS (FULL) ================= -->

<link rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded",function(){

  /* DATATABLE */
  if ($('#rdfsDepositTable').length && $.fn.DataTable) {
    $('#rdfsDepositTable').DataTable({
      pageLength:5,
      lengthMenu:[5,10,25,50],
      order:[],
      language:{
        search:"_INPUT_",
        searchPlaceholder:"Search deposits..."
      }
    });
  }

  if ($('#rdfsVehicleSelect').length && $.fn.select2) {
    $('#rdfsVehicleSelect').select2({
      placeholder:'Search plate or driver',
      dropdownCssClass:'rdfs-select2-dropdown',
      width:'100%',
      allowClear:true,
      minimumResultsForSearch:0
    });
  }

  /* WALLET BALANCE AJAX */
  if ($('#rdfsVehicleSelect').length) {
    $('#rdfsVehicleSelect').on('change',function(){
      const vehicleId=$(this).val();
      const info=$('#rdfsWalletInfo');

      if(!vehicleId){
        info.html('');
        return;
      }

      info.html(
        '<i class="fa-solid fa-arrows-rotate rdfs-deposit-spin me-1"></i> Checking balance...'
      );

      $.get("{% url 'terminal:ajax_get_wallet_balance' %}",{vehicle_id:vehicleId})
        .done(function(res){
          if(res.success){
            info.html(
              `üí∞ Current Balance for <strong>${res.vehicle}</strong>: ‚Ç±${res.balance.toFixed(2)}`
            );
          }else{
            info.html(`<span class="text-danger">‚ö†Ô∏è ${res.message}</span>`);
          }
        });
    });
  }

  const actionMessages = [
    {% for message in messages %}
    {text:"{{ message|escapejs }}"}{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  const toastEl = document.getElementById("rdfsActionToast");
  const toastText = document.getElementById("rdfsActionToastText");
  let toastIndex = 0;
  let toastTimer;

  function showToast(message){
    if(!toastEl || !message) return;
    toastText.textContent = message.text;
    toastEl.classList.add("visible");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{
      toastEl.classList.remove("visible");
      setTimeout(()=>{
        toastIndex += 1;
        if(toastIndex < actionMessages.length){
          showToast(actionMessages[toastIndex]);
        }
      }, 250);
    }, 3000);
  }

  if(actionMessages.length){
    showToast(actionMessages[0]);
  }

});
</script>

{% endblock %}
