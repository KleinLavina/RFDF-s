{% extends "base.html" %}
{% load static %}

{% block title %}Driver Wallets | RDFS{% endblock %}

{% block content %}

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" href="{% static 'styles/deposit_menu.css' %}" />

<div class="p-4 rdfs-deposit-scope">
  <div class="rdfs-deposit-container">

    <div class="wallets-header">
      <div>
        <h3 class="wallets-title mb-1">
          <i class="fa-solid fa-wallet me-2"></i>
          Driver Wallets
        </h3>
        <p class="wallets-note mb-0">
          Minimum required before entry:
          <strong>‚Ç±{{ min_deposit }}</strong>
        </p>
        <p class="text-muted small mb-0">
          Showing {{ wallets|length }} of {{ wallets_total }} wallets.
        </p>
      </div>
      <div class="wallets-actions">
        <button type="button"
                class="btn btn-primary me-2"
                data-bs-toggle="modal"
                data-bs-target="#addDepositModal">
          <i class="fa-solid fa-circle-plus me-1"></i>
          Add Deposit
        </button>
        <a href="{% url 'terminal:deposit_history' %}"
           class="btn btn-outline-secondary">
          <i class="fa-solid fa-clock me-1"></i>
          Deposit History
        </a>
      </div>
    </div>

    <div id="rdfsActionToast" class="rdfs-action-toast" role="status" aria-live="polite">
      <i class="fa-solid fa-circle-check"></i>
      <span id="rdfsActionToastText"></span>
    </div>

    <section class="wallets-toolbar card border-0 mb-4">
      <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Search by driver or plate</label>
            <input type="text"
                   name="search_query"
                   value="{{ wallet_search }}"
                   class="form-control"
                   placeholder="Type driver name, license, or plate">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Sort wallets</label>
            <select name="wallet_sort" class="form-select">
              <option value="newest" {% if wallet_sort == 'newest' %}selected{% endif %}>
                Newest deposits
              </option>
              <option value="largest" {% if wallet_sort == 'largest' %}selected{% endif %}>
                Largest deposits
              </option>
              <option value="smallest" {% if wallet_sort == 'smallest' %}selected{% endif %}>
                Smallest deposits
              </option>
              <option value="driver_asc" {% if wallet_sort == 'driver_asc' %}selected{% endif %}>
                Driver A ‚Üí Z
              </option>
              <option value="driver_desc" {% if wallet_sort == 'driver_desc' %}selected{% endif %}>
                Driver Z ‚Üí A
              </option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-outline-primary w-100">
              <i class="fa-solid fa-arrow-down-up me-1"></i>
              Apply
            </button>
          </div>
        </form>
      </div>
    </section>

    <section class="wallets-table card border-0 mb-4">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light text-muted small text-uppercase">
              <tr>
                <th>#</th>
                <th>Driver</th>
                <th>Plate</th>
                <th>Balance</th>
                <th>Last deposit</th>
                <th>Date</th>
                <th>Records</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% if wallets %}
                {% for wallet in wallets %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                      {{ wallet.vehicle.assigned_driver.first_name }}
                      {{ wallet.vehicle.assigned_driver.last_name }}
                    </td>
                    <td>{{ wallet.vehicle.license_plate }}</td>
                    <td>‚Ç±{{ wallet.balance|floatformat:2 }}</td>
                    <td>‚Ç±{{ wallet.last_deposit_amount|default:"0.00"|floatformat:2 }}</td>
                    <td>
                      {% if wallet.last_deposit_at %}
                        {{ wallet.last_deposit_at|date:"M d, Y h:i A" }}
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </td>
                    <td>{{ wallet.deposit_count }}</td>
                    <td>
                      <button type="button"
                              class="btn btn-sm btn-outline-primary wallet-deposit-btn"
                              data-vehicle="{{ wallet.vehicle.id }}"
                              data-display="{{ wallet.vehicle.assigned_driver.first_name }} {{ wallet.vehicle.assigned_driver.last_name }} ¬∑ {{ wallet.vehicle.license_plate }}">
                        Deposit
                      </button>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    No wallets match the current filters.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Add Deposit Modal -->
<div class="modal fade" id="addDepositModal" tabindex="-1" aria-labelledby="addDepositModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="addDepositModalLabel">
          <i class="fa-solid fa-circle-plus me-1"></i>
          Add Deposit
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{% url 'terminal:deposit_menu' %}" id="rdfsAddDepositForm">
          {% csrf_token %}
          <input type="hidden" name="vehicle_id" id="rdfsVehicleId">

          <div class="mb-3 position-relative">
            <label class="form-label fw-semibold">Driver name or license</label>
            <input type="text"
                   id="rdfsDriverSearch"
                   class="form-control"
                   placeholder="Type driver, license, or plate">
            <div id="rdfsDriverSuggestions" class="driver-suggestions shadow"></div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Deposit Amount (‚Ç±)</label>
            <input type="number"
                   name="amount"
                   min="1"
                   step="0.01"
                   class="form-control"
                   placeholder="Enter amount"
                   required>
          </div>

          <div class="mb-3">
            <p id="rdfsSelectedDriverLabel" class="mb-1 text-muted small">
              Search by driver name, license, plate, or driver ID.
            </p>
            <div id="rdfsWalletInfo" class="small fw-semibold text-muted"></div>
          </div>

          <button type="submit" class="btn btn-primary w-100" id="rdfsAddDepositBtn" disabled>
            <i class="fa-solid fa-hand-holding-dollar me-1"></i>
            Add Deposit
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{{ driver_options|json_script:"driver-options-data" }}
<script>
  window.driverOptions = JSON.parse(document.getElementById("driver-options-data").textContent || "[]");
</script>
{{ toast_messages|json_script:"rdfs-toast-messages" }}
<script>
  window.actionMessages = JSON.parse(document.getElementById("rdfs-toast-messages").textContent || "[]");
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const driverInput = document.getElementById("rdfsDriverSearch");
  const suggestionBox = document.getElementById("rdfsDriverSuggestions");
  const vehicleField = document.getElementById("rdfsVehicleId");
  const walletInfo = document.getElementById("rdfsWalletInfo");
  const addButton = document.getElementById("rdfsAddDepositBtn");
  const selectedLabel = document.getElementById("rdfsSelectedDriverLabel");
  const driverOptions = window.driverOptions || [];

  const showToast = (message, isError=false) => {
    const toastEl = document.getElementById("rdfsActionToast");
    const toastText = document.getElementById("rdfsActionToastText");
    if (!toastEl || !toastText) return;
    toastText.textContent = message;
    toastEl.classList.toggle("visible", !isError);
    setTimeout(() => toastEl.classList.remove("visible"), 3000);
  };

  function renderSuggestions(value) {
    suggestionBox.innerHTML = "";
    const query = value.trim().toLowerCase();
    if (!query) {
      return;
    }

    const matches = driverOptions.filter(option => {
      return (
        option.driver_name.toLowerCase().includes(query) ||
        option.license_plate.toLowerCase().includes(query) ||
        (option.license_number || "").toLowerCase().includes(query)
      );
    }).slice(0, 6);

    if (!matches.length) {
      const row = document.createElement("div");
      row.className = "driver-suggestion empty";
      row.textContent = "No matching driver found.";
      suggestionBox.appendChild(row);
      return;
    }

    matches.forEach(option => {
      const row = document.createElement("button");
      row.type = "button";
      row.className = "driver-suggestion";
      row.dataset.vehicleId = option.vehicle_id;
      row.dataset.display = option.display;
      row.dataset.license = option.license_number || "N/A";
      row.innerHTML = `<strong>${option.display}</strong>
                       <span class="text-muted small d-block">License: ${option.license_number || 'N/A'}</span>`;
      suggestionBox.appendChild(row);
    });
  }

  function toggleSubmitState() {
    addButton.disabled = !vehicleField.value;
  }

  driverInput.addEventListener("input", function () {
    suggestionBox.innerHTML = "";
    walletInfo.textContent = "";
    vehicleField.value = "";
    selectedLabel.textContent = driverInput.value
      ? `Searching for "${driverInput.value}"`
      : "Search by driver name, license, plate, or driver ID.";
    toggleSubmitState();
    renderSuggestions(driverInput.value);
  });

  suggestionBox.addEventListener("click", function (event) {
    const entry = event.target.closest(".driver-suggestion");
    if (!entry || !entry.dataset.vehicleId) return;
    const vehicleId = entry.dataset.vehicleId;
    const display = entry.dataset.display;

    vehicleField.value = vehicleId;
    driverInput.value = display;
    selectedLabel.textContent = display;
    suggestionBox.innerHTML = "";
    toggleSubmitState();
    fetchBalance(vehicleId);
  });

  document.addEventListener("click", function (event) {
    if (!suggestionBox.contains(event.target) && event.target !== driverInput) {
      suggestionBox.innerHTML = "";
    }
  });

  function fetchBalance(vehicleId) {
    walletInfo.innerHTML = '<i class="fa-solid fa-arrows-rotate rdfs-deposit-spin me-1"></i> Checking balance...';
    fetch(`{% url 'terminal:ajax_get_wallet_balance' %}?vehicle_id=${vehicleId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          walletInfo.innerHTML = `üí∞ Current balance for <strong>${data.vehicle}</strong>: ‚Ç±${data.balance.toFixed(2)}`;
        } else {
          walletInfo.innerHTML = `<span class="text-danger">‚ö†Ô∏è ${data.message}</span>`;
        }
      })
      .catch(() => {
        walletInfo.innerHTML = "";
      });
  }

  const addDepositModalEl = document.getElementById("addDepositModal");
  const bootstrapModal = window.bootstrap && addDepositModalEl
    ? new bootstrap.Modal(addDepositModalEl)
    : null;

  document.querySelectorAll(".wallet-deposit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const vehicleId = btn.dataset.vehicle;
      const display = btn.dataset.display;

      if (!vehicleId) return;

      driverInput.value = display;
      vehicleField.value = vehicleId;
      selectedLabel.textContent = display;
      toggleSubmitState();
      suggestionBox.innerHTML = "";
      fetchBalance(vehicleId);

      if (bootstrapModal) {
        bootstrapModal.show();
      }
    });
  });

  const actionMessages = window.actionMessages || [];

  let toastIndex = 0;
  function queueToast(index) {
    if (!actionMessages[index]) return;
    showToast(actionMessages[index]);
    setTimeout(() => {
      toastIndex += 1;
      if (toastIndex < actionMessages.length) {
        queueToast(toastIndex);
      }
    }, 3200);
  }

  if (actionMessages.length) {
    queueToast(0);
  }

  toggleSubmitState();
});
</script>

{% endblock %}
