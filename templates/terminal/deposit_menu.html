{% extends "base.html" %}
{% load static %}

{% block title %}Driver Wallets | RDFS{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
/* ============================================
   DEPOSIT MENU - MODERN STYLING
============================================ */
.rdfs-deposit-scope {
  --primary: #3b82f6;
  --primary-dark: #1d4ed8;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-500: #6b7280;
  --gray-700: #374151;
  --gray-900: #111827;
  
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
}

.wallets-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.wallets-title {
  font-weight: 700;
  color: var(--gray-900);
  font-size: 1.5rem;
}

.wallets-note {
  color: var(--gray-500);
  font-size: 0.9rem;
}

.wallets-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

/* Toast */
.rdfs-action-toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 500;
  box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 9999;
}

.rdfs-action-toast.visible {
  transform: translateY(0);
  opacity: 1;
}

/* Toolbar Card */
.wallets-toolbar {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.search-input-wrapper {
  position: relative;
}

.search-input-wrapper i {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray-500);
}

.search-input-wrapper input {
  padding-left: 42px;
  border-radius: 10px;
  border: 2px solid var(--gray-200);
  transition: all 0.2s;
}

.search-input-wrapper input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
}

/* Stats Row */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 1rem 1.25rem;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
  border-left: 4px solid var(--primary);
}

.stat-card.success { border-left-color: var(--success); }
.stat-card.warning { border-left-color: var(--warning); }

.stat-card__label {
  font-size: 0.75rem;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.25rem;
}

.stat-card__value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--gray-900);
}

/* Table Card */
.wallets-table-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.wallets-table {
  margin: 0;
}

.wallets-table thead th {
  background: var(--gray-50);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--gray-500);
  padding: 1rem;
  border-bottom: 1px solid var(--gray-200);
}

.wallets-table tbody tr {
  transition: background 0.15s;
}

.wallets-table tbody tr:hover {
  background: var(--gray-50);
}

.wallets-table tbody td {
  padding: 1rem;
  vertical-align: middle;
  border-bottom: 1px solid var(--gray-100);
}

.balance-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.35rem 0.75rem;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.85rem;
}

.balance-badge.high {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

.balance-badge.medium {
  background: rgba(59, 130, 246, 0.1);
  color: var(--primary);
}

.balance-badge.low {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
}

.balance-badge.critical {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

/* Loading Indicator */
.loading-indicator {
  display: none;
  align-items: center;
  gap: 0.5rem;
  color: var(--primary);
  font-size: 0.85rem;
}

.loading-indicator.active {
  display: flex;
}

.loading-indicator i {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Driver Suggestions */
.driver-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border-radius: 10px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.driver-suggestions:not(:empty) {
  display: block;
  border: 1px solid var(--gray-200);
}

.driver-suggestion {
  display: block;
  width: 100%;
  padding: 0.75rem 1rem;
  text-align: left;
  border: none;
  background: none;
  cursor: pointer;
  transition: background 0.15s;
}

.driver-suggestion:hover {
  background: var(--gray-50);
}

.driver-suggestion.empty {
  color: var(--gray-500);
  cursor: default;
}

/* Responsive */
@media (max-width: 768px) {
  .wallets-header {
    flex-direction: column;
  }
  
  .wallets-actions {
    width: 100%;
  }
  
  .wallets-actions .btn {
    flex: 1;
  }
}
</style>

<div class="p-4 rdfs-deposit-scope">
  <div class="rdfs-deposit-container">

    <!-- Header -->
    <div class="wallets-header">
      <div>
        <h3 class="wallets-title mb-1">
          <i class="fa-solid fa-wallet me-2 text-primary"></i>
          Driver Wallets
        </h3>
        <p class="wallets-note mb-0">
          Minimum required before entry:
          <strong class="text-primary">₱{{ min_deposit }}</strong>
        </p>
        <p class="text-muted small mb-0" id="walletCountDisplay">
          Showing <span id="visibleCount">{{ wallets|length }}</span> of <span id="totalCount">{{ wallets_total }}</span> wallets
        </p>
      </div>
      <div class="wallets-actions">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDepositModal">
          <i class="fa-solid fa-circle-plus me-1"></i>
          Add Deposit
        </button>
        <a href="{% url 'terminal:deposit_history' %}" class="btn btn-outline-secondary">
          <i class="fa-solid fa-clock me-1"></i>
          Deposit History
        </a>
      </div>
    </div>

    <!-- Toast -->
    <div id="rdfsActionToast" class="rdfs-action-toast" role="status" aria-live="polite">
      <i class="fa-solid fa-circle-check"></i>
      <span id="rdfsActionToastText"></span>
    </div>

    <!-- Search & Filter Toolbar -->
    <section class="wallets-toolbar card border-0 mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-semibold small text-muted">
              <i class="fa-solid fa-search me-1"></i> LIVE SEARCH
            </label>
            <div class="search-input-wrapper">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input type="text"
                     id="liveSearchInput"
                     class="form-control"
                     placeholder="Type to search driver, license, or plate..."
                     value="{{ wallet_search }}">
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold small text-muted">
              <i class="fa-solid fa-sort me-1"></i> SORT BY
            </label>
            <select id="liveSortSelect" class="form-select">
              <option value="newest" {% if wallet_sort == 'newest' %}selected{% endif %}>
                Newest deposits
              </option>
              <option value="largest" {% if wallet_sort == 'largest' %}selected{% endif %}>
                Largest balance
              </option>
              <option value="smallest" {% if wallet_sort == 'smallest' %}selected{% endif %}>
                Smallest balance
              </option>
              <option value="driver_asc" {% if wallet_sort == 'driver_asc' %}selected{% endif %}>
                Driver A → Z
              </option>
              <option value="driver_desc" {% if wallet_sort == 'driver_desc' %}selected{% endif %}>
                Driver Z → A
              </option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-center">
            <div class="loading-indicator" id="loadingIndicator">
              <i class="fa-solid fa-spinner"></i>
              <span>Searching...</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Wallets Table -->
    <section class="wallets-table-card mb-4">
      <div class="table-responsive">
        <table class="table wallets-table mb-0 align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Driver</th>
              <th>Plate</th>
              <th>Balance</th>
              <th>Last Deposit</th>
              <th>Date</th>
              <th>Records</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="walletsTableBody">
            {% if wallets %}
              {% for wallet in wallets %}
                <tr data-driver="{{ wallet.vehicle.assigned_driver.first_name|lower }} {{ wallet.vehicle.assigned_driver.last_name|lower }}"
                    data-plate="{{ wallet.vehicle.license_plate|lower }}"
                    data-license="{{ wallet.vehicle.assigned_driver.license_number|lower|default:'' }}"
                    data-balance="{{ wallet.balance }}"
                    data-date="{{ wallet.last_deposit_at|date:'Y-m-d H:i:s'|default:'0000-00-00' }}">
                  <td class="row-number">{{ forloop.counter }}</td>
                  <td class="driver-name">
                    <strong>{{ wallet.vehicle.assigned_driver.first_name }} {{ wallet.vehicle.assigned_driver.last_name }}</strong>
                  </td>
                  <td>
                    <span class="badge bg-light text-dark border">{{ wallet.vehicle.license_plate }}</span>
                  </td>
                  <td>
                    {% if wallet.balance >= 500 %}
                      <span class="balance-badge high">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% elif wallet.balance >= 200 %}
                      <span class="balance-badge medium">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% elif wallet.balance >= 100 %}
                      <span class="balance-badge low">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% else %}
                      <span class="balance-badge critical">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% endif %}
                  </td>
                  <td>₱{{ wallet.last_deposit_amount|default:"0.00"|floatformat:2 }}</td>
                  <td>
                    {% if wallet.last_deposit_at %}
                      {{ wallet.last_deposit_at|date:"M d, Y h:i A" }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-secondary">{{ wallet.deposit_count }}</span>
                  </td>
                  <td>
                    <button type="button"
                            class="btn btn-sm btn-primary wallet-deposit-btn"
                            data-vehicle="{{ wallet.vehicle.id }}"
                            data-display="{{ wallet.vehicle.assigned_driver.first_name }} {{ wallet.vehicle.assigned_driver.last_name }} · {{ wallet.vehicle.license_plate }}">
                      <i class="fa-solid fa-plus me-1"></i> Deposit
                    </button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr id="emptyRow">
                <td colspan="8" class="text-center text-muted py-4">
                  <i class="fa-solid fa-inbox fs-1 d-block mb-2 opacity-50"></i>
                  No wallets found.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

  </div>
</div>

<!-- Add Deposit Modal -->
<div class="modal fade" id="addDepositModal" tabindex="-1" aria-labelledby="addDepositModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-0 bg-primary text-white">
        <h5 class="modal-title" id="addDepositModalLabel">
          <i class="fa-solid fa-hand-holding-dollar me-2"></i>
          Add Deposit
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form method="POST" action="{% url 'terminal:deposit_menu' %}" id="rdfsAddDepositForm">
          {% csrf_token %}
          <input type="hidden" name="vehicle_id" id="rdfsVehicleId">

          <div class="mb-3 position-relative">
            <label class="form-label fw-semibold">Driver or Vehicle</label>
            <input type="text"
                   id="rdfsDriverSearch"
                   class="form-control"
                   placeholder="Search driver name, license, or plate">
            <div id="rdfsDriverSuggestions" class="driver-suggestions shadow"></div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Deposit Amount (₱)</label>
            <input type="number"
                   name="amount"
                   min="1"
                   step="0.01"
                   class="form-control form-control-lg"
                   placeholder="0.00"
                   required>
          </div>

          <div class="mb-3 p-3 bg-light rounded">
            <p id="rdfsSelectedDriverLabel" class="mb-1 text-muted small">
              <i class="fa-solid fa-info-circle me-1"></i>
              Select a driver to proceed
            </p>
            <div id="rdfsWalletInfo" class="fw-semibold text-primary"></div>
          </div>

          <button type="submit" class="btn btn-primary btn-lg w-100" id="rdfsAddDepositBtn" disabled>
            <i class="fa-solid fa-check-circle me-1"></i>
            Confirm Deposit
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{{ driver_options|json_script:"driver-options-data" }}
{{ toast_messages|json_script:"rdfs-toast-messages" }}

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ============================================
  // LIVE SEARCH & FILTER (NO BUTTON REQUIRED)
  // ============================================
  const searchInput = document.getElementById("liveSearchInput");
  const sortSelect = document.getElementById("liveSortSelect");
  const tableBody = document.getElementById("walletsTableBody");
  const loadingIndicator = document.getElementById("loadingIndicator");
  const visibleCountEl = document.getElementById("visibleCount");
  
  let debounceTimer = null;
  const allRows = Array.from(tableBody.querySelectorAll("tr[data-driver]"));
  
  function filterAndSort() {
    const query = searchInput.value.toLowerCase().trim();
    const sortBy = sortSelect.value;
    
    // Show loading
    loadingIndicator.classList.add("active");
    
    // Filter rows
    let visibleRows = allRows.filter(row => {
      if (!query) return true;
      const driver = row.dataset.driver || "";
      const plate = row.dataset.plate || "";
      const license = row.dataset.license || "";
      return driver.includes(query) || plate.includes(query) || license.includes(query);
    });
    
    // Sort rows
    visibleRows.sort((a, b) => {
      switch (sortBy) {
        case "largest":
          return parseFloat(b.dataset.balance || 0) - parseFloat(a.dataset.balance || 0);
        case "smallest":
          return parseFloat(a.dataset.balance || 0) - parseFloat(b.dataset.balance || 0);
        case "driver_asc":
          return (a.dataset.driver || "").localeCompare(b.dataset.driver || "");
        case "driver_desc":
          return (b.dataset.driver || "").localeCompare(a.dataset.driver || "");
        case "newest":
        default:
          return (b.dataset.date || "").localeCompare(a.dataset.date || "");
      }
    });
    
    // Hide all rows first
    allRows.forEach(row => row.style.display = "none");
    
    // Show and reorder visible rows
    visibleRows.forEach((row, index) => {
      row.style.display = "";
      row.querySelector(".row-number").textContent = index + 1;
      tableBody.appendChild(row); // Move to end to maintain order
    });
    
    // Update count
    visibleCountEl.textContent = visibleRows.length;
    
    // Show empty state if no results
    let emptyRow = tableBody.querySelector("#emptyRow");
    if (visibleRows.length === 0) {
      if (!emptyRow) {
        emptyRow = document.createElement("tr");
        emptyRow.id = "emptyRow";
        emptyRow.innerHTML = `
          <td colspan="8" class="text-center text-muted py-4">
            <i class="fa-solid fa-search fs-1 d-block mb-2 opacity-50"></i>
            No wallets match "${searchInput.value}"
          </td>
        `;
        tableBody.appendChild(emptyRow);
      }
      emptyRow.style.display = "";
    } else if (emptyRow) {
      emptyRow.style.display = "none";
    }
    
    // Hide loading
    setTimeout(() => loadingIndicator.classList.remove("active"), 150);
  }
  
  // Debounced search
  searchInput.addEventListener("input", function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(filterAndSort, 200);
  });
  
  // Instant sort change
  sortSelect.addEventListener("change", filterAndSort);
  
  // Initial filter/sort on page load
  filterAndSort();

  // ============================================
  // ADD DEPOSIT MODAL LOGIC
  // ============================================
  const driverInput = document.getElementById("rdfsDriverSearch");
  const suggestionBox = document.getElementById("rdfsDriverSuggestions");
  const vehicleField = document.getElementById("rdfsVehicleId");
  const walletInfo = document.getElementById("rdfsWalletInfo");
  const addButton = document.getElementById("rdfsAddDepositBtn");
  const selectedLabel = document.getElementById("rdfsSelectedDriverLabel");
  const driverOptions = JSON.parse(document.getElementById("driver-options-data").textContent || "[]");

  const showToast = (message) => {
    const toastEl = document.getElementById("rdfsActionToast");
    const toastText = document.getElementById("rdfsActionToastText");
    if (!toastEl || !toastText) return;
    toastText.textContent = message;
    toastEl.classList.add("visible");
    setTimeout(() => toastEl.classList.remove("visible"), 3500);
  };

  function renderSuggestions(value) {
    suggestionBox.innerHTML = "";
    const query = value.trim().toLowerCase();
    if (!query) return;

    const matches = driverOptions.filter(option => {
      return (
        option.driver_name.toLowerCase().includes(query) ||
        option.license_plate.toLowerCase().includes(query) ||
        (option.license_number || "").toLowerCase().includes(query)
      );
    }).slice(0, 6);

    if (!matches.length) {
      const row = document.createElement("div");
      row.className = "driver-suggestion empty";
      row.innerHTML = '<i class="fa-solid fa-user-slash me-2 opacity-50"></i> No matching driver found';
      suggestionBox.appendChild(row);
      return;
    }

    matches.forEach(option => {
      const row = document.createElement("button");
      row.type = "button";
      row.className = "driver-suggestion";
      row.dataset.vehicleId = option.vehicle_id;
      row.dataset.display = option.display;
      row.innerHTML = `
        <div class="fw-semibold">${option.display}</div>
        <div class="text-muted small">License: ${option.license_number || 'N/A'}</div>
      `;
      suggestionBox.appendChild(row);
    });
  }

  function toggleSubmitState() {
    addButton.disabled = !vehicleField.value;
  }

  driverInput.addEventListener("input", function () {
    suggestionBox.innerHTML = "";
    walletInfo.textContent = "";
    vehicleField.value = "";
    selectedLabel.innerHTML = driverInput.value
      ? `<i class="fa-solid fa-search me-1"></i> Searching for "${driverInput.value}"...`
      : '<i class="fa-solid fa-info-circle me-1"></i> Select a driver to proceed';
    toggleSubmitState();
    renderSuggestions(driverInput.value);
  });

  suggestionBox.addEventListener("click", function (event) {
    const entry = event.target.closest(".driver-suggestion");
    if (!entry || !entry.dataset.vehicleId) return;
    
    vehicleField.value = entry.dataset.vehicleId;
    driverInput.value = entry.dataset.display;
    selectedLabel.innerHTML = `<i class="fa-solid fa-user-check me-1 text-success"></i> ${entry.dataset.display}`;
    suggestionBox.innerHTML = "";
    toggleSubmitState();
    fetchBalance(entry.dataset.vehicleId);
  });

  document.addEventListener("click", function (event) {
    if (!suggestionBox.contains(event.target) && event.target !== driverInput) {
      suggestionBox.innerHTML = "";
    }
  });

  function fetchBalance(vehicleId) {
    walletInfo.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i> Checking balance...';
    fetch(`{% url 'terminal:ajax_get_wallet_balance' %}?vehicle_id=${vehicleId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          walletInfo.innerHTML = `<i class="fa-solid fa-wallet me-1"></i> Current balance: <strong>₱${data.balance.toFixed(2)}</strong>`;
        } else {
          walletInfo.innerHTML = `<span class="text-danger"><i class="fa-solid fa-exclamation-triangle me-1"></i> ${data.message}</span>`;
        }
      })
      .catch(() => {
        walletInfo.innerHTML = "";
      });
  }

  // Quick deposit buttons
  const addDepositModalEl = document.getElementById("addDepositModal");
  const bootstrapModal = window.bootstrap && addDepositModalEl ? new bootstrap.Modal(addDepositModalEl) : null;

  document.querySelectorAll(".wallet-deposit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const vehicleId = btn.dataset.vehicle;
      const display = btn.dataset.display;
      if (!vehicleId) return;

      driverInput.value = display;
      vehicleField.value = vehicleId;
      selectedLabel.innerHTML = `<i class="fa-solid fa-user-check me-1 text-success"></i> ${display}`;
      toggleSubmitState();
      suggestionBox.innerHTML = "";
      fetchBalance(vehicleId);

      if (bootstrapModal) bootstrapModal.show();
    });
  });

  // Show toast messages
  const actionMessages = JSON.parse(document.getElementById("rdfs-toast-messages").textContent || "[]");
  if (actionMessages.length) {
    actionMessages.forEach((msg, i) => setTimeout(() => showToast(msg), i * 3200));
  }

  toggleSubmitState();
});
</script>

{% endblock %}
