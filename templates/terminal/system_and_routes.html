{% extends 'base.html' %}
{% load static %}
{% block title %}System & Routes | RDFS{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'styles/terminal/01.css' %}">

<div class="container-fluid system-routes-page">

  <!-- PAGE HEADER -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-cogs me-2"></i>
        System & Routes Management
      </h1>
      <p class="page-subtitle">
        <i class="fas fa-info-circle me-1"></i>
        Configure system settings and manage terminal routes
      </p>
    </div>

    <a href="{% url 'accounts:admin_dashboard' %}" class="btn-back">
      <i class="fas fa-arrow-left me-2"></i>
      Back to Dashboard
    </a>
  </div>

  <!-- FLASH MESSAGES -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- TABS NAVIGATION -->
  <div class="tabs-container">
    <button class="tab-btn active" data-tab="settings">
      <i class="fas fa-sliders-h me-2"></i>
      System Settings
    </button>
    <button class="tab-btn" data-tab="routes">
      <i class="fas fa-route me-2"></i>
      Route Management
    </button>
  </div>

  <!-- TAB CONTENT: SYSTEM SETTINGS -->
  <div class="tab-content active" id="settings-tab">
    
    <!-- CURRENT FEE BANNER -->
    <div class="info-banner">
      <div class="banner-content">
        <i class="fas fa-coins me-2"></i>
        <strong>Current Terminal Fee:</strong>
        <span class="fee-amount">₱{{ form.instance.terminal_fee }}</span>
      </div>
      <small class="banner-meta">
        Last updated: {{ form.instance.updated_at|date:"M d, Y H:i" }}
      </small>
    </div>

    <!-- SETTINGS FORM -->
    <div class="content-card">
      <form method="POST" id="settingsForm" novalidate>
        {% csrf_token %}

        <!-- BASIC SETTINGS -->
        <div class="settings-section">
          <h2 class="section-title">
            <i class="fas fa-dollar-sign me-2"></i>
            Basic Configuration
          </h2>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-money-bill-wave me-1"></i>
                Terminal Entry Fee (₱)
              </label>
              {{ form.terminal_fee }}
              {% if form.terminal_fee.errors %}
                <div class="error-message">{{ form.terminal_fee.errors|striptags }}</div>
              {% endif %}
              <small class="form-hint">Fee charged per vehicle entry</small>
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-piggy-bank me-1"></i>
                Minimum Deposit (₱)
              </label>
              {{ form.min_deposit_amount }}
              {% if form.min_deposit_amount.errors %}
                <div class="error-message">{{ form.min_deposit_amount.errors|striptags }}</div>
              {% endif %}
              <small class="form-hint">Required minimum wallet balance</small>
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-clock me-1"></i>
                Entry Cooldown (minutes)
              </label>
              {{ form.entry_cooldown_minutes }}
              {% if form.entry_cooldown_minutes.errors %}
                <div class="error-message">{{ form.entry_cooldown_minutes.errors|striptags }}</div>
              {% endif %}
              <small class="form-hint">Time between consecutive entries</small>
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-hourglass-half me-1"></i>
                Stay Duration (minutes)
              </label>
              {{ form.departure_duration_minutes }}
              {% if form.departure_duration_minutes.errors %}
                <div class="error-message">{{ form.departure_duration_minutes.errors|striptags }}</div>
              {% endif %}
              <small class="form-hint">Max time before departure</small>
            </div>
          </div>
        </div>

        <!-- QUEUE DISPLAY SETTINGS -->
        <div class="settings-section">
          <h2 class="section-title">
            <i class="fas fa-tv me-2"></i>
            Queue Display Settings
          </h2>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-stopwatch me-1"></i>
                Countdown Duration (seconds)
              </label>
              {{ form.countdown_duration_seconds }}
              {% if form.countdown_duration_seconds.errors %}
                <div class="error-message">{{ form.countdown_duration_seconds.errors|striptags }}</div>
              {% endif %}
              <small class="form-hint">Timer duration (5-300 seconds)</small>
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-sync-alt me-1"></i>
                Auto-Refresh Interval (seconds)
              </label>
              {{ form.queue_refresh_interval_seconds }}
              {% if form.queue_refresh_interval_seconds.errors %}
                <div class="error-message">{{ form.queue_refresh_interval_seconds.errors|striptags }}</div>
              {% endif %}
              <small class="form-hint">Display refresh rate (5-120 seconds)</small>
            </div>
          </div>
        </div>

        <!-- SEAT CAPACITY LIMITS -->
        <div class="settings-section">
          <h2 class="section-title">
            <i class="fas fa-bus me-2"></i>
            Seat Capacity Limits
          </h2>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-shuttle-van me-1"></i>
                Jeepney Max Seats
              </label>
              {{ form.jeepney_max_seats }}
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-van-shuttle me-1"></i>
                Van Max Seats
              </label>
              {{ form.van_max_seats }}
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-bus-alt me-1"></i>
                Bus Max Seats
              </label>
              {{ form.bus_max_seats }}
            </div>
          </div>
        </div>

        <!-- ACTIONS -->
        <div class="form-actions">
          <button type="button" class="btn-save" id="openConfirmModal">
            <i class="fas fa-check-circle me-2"></i>
            Save Settings
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- TAB CONTENT: ROUTES -->
  <div class="tab-content" id="routes-tab">
    
    <!-- ROUTE STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon active-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ active_routes }}</div>
          <div class="stat-label">Active Routes</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon trips-icon">
          <i class="fas fa-road"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ total_trips }}</div>
          <div class="stat-label">Total Trips</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon fees-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">₱{{ total_fees|floatformat:2 }}</div>
          <div class="stat-label">Total Fees</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon top-icon">
          <i class="fas fa-trophy"></i>
        </div>
        <div class="stat-info">
          {% if top_route %}
            <div class="stat-value small-text">
              {{ top_route.vehicle__route__origin }} → {{ top_route.vehicle__route__destination }}
            </div>
            <div class="stat-label">Top Route ({{ top_route.total_trips }} trips)</div>
          {% else %}
            <div class="stat-value">—</div>
            <div class="stat-label">No Data</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- CHART -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-chart-bar me-2"></i>
        Route Activity Overview
      </h2>
      <canvas id="routesChart" height="80"></canvas>
    </div>

    <!-- ADD ROUTE FORM -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-plus-circle me-2"></i>
        Add New Route
      </h2>

      <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="action" value="add">

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Origin</label>
            <input type="text" name="origin" class="form-control" required>
          </div>

          <div class="form-group">
            <label class="form-label">Destination</label>
            <input type="text" name="destination" class="form-control" required>
          </div>

          <div class="form-group">
            <label class="form-label">Base Fare (₱)</label>
            <input type="number" name="base_fare" step="0.01" class="form-control">
          </div>

          <div class="form-group">
            <label class="form-label">Status</label>
            <div class="form-check-inline">
              <input class="form-check-input" type="checkbox" name="active" checked id="activeCheck">
              <label class="form-check-label" for="activeCheck">Active</label>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-add">
            <i class="fas fa-plus-circle me-2"></i>
            Add Route
          </button>
        </div>
      </form>
    </div>

    <!-- ROUTES TABLE -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-list me-2"></i>
        Existing Routes
      </h2>

      <div class="table-container">
        <table class="routes-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Origin</th>
              <th>Destination</th>
              <th>Fare</th>
              <th>Status</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for route in routes %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td class="fw-semibold">{{ route.origin }}</td>
              <td class="fw-semibold">{{ route.destination }}</td>
              <td>₱{{ route.base_fare|floatformat:2 }}</td>
              <td>
                <span class="status-badge {% if route.active %}status-active{% else %}status-inactive{% endif %}">
                  {{ route.active|yesno:"Active,Inactive" }}
                </span>
              </td>
              <td class="text-center">
                <button class="btn-action btn-edit" 
                        data-id="{{ route.id }}"
                        data-origin="{{ route.origin }}"
                        data-destination="{{ route.destination }}"
                        data-fare="{{ route.base_fare }}"
                        data-active="{{ route.active }}">
                  <i class="fas fa-edit"></i>
                </button>
                <form method="POST" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete">
                  <input type="hidden" name="route_id" value="{{ route.id }}">
                  <button class="btn-action btn-delete" onclick="return confirm('Delete this route?');">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                <i class="fas fa-inbox me-2"></i>
                No routes found. Add one above.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- CONFIRM SETTINGS MODAL -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Confirm Update
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="fw-semibold mb-1">Are you sure you want to update the system settings?</p>
        <p class="text-muted small mb-0">Changes will apply immediately to all future vehicle entries.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" id="confirmSaveBtn">
          <i class="fas fa-check-circle me-1"></i>
          Yes, Update
        </button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT ROUTE MODAL -->
<div class="modal fade" id="editRouteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="action" value="edit">
        <input type="hidden" name="route_id" id="editRouteId">

        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-edit me-2"></i>
            Edit Route
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Origin</label>
            <input id="editOrigin" name="origin" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Destination</label>
            <input id="editDestination" name="destination" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Base Fare (₱)</label>
            <input id="editFare" name="base_fare" type="number" step="0.01" class="form-control">
          </div>
          <div class="form-check">
            <input id="editActive" name="active" type="checkbox" class="form-check-input">
            <label class="form-check-label">Active</label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-check-circle me-1"></i>
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  
  // TAB SWITCHING
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetTab = btn.dataset.tab;
      
      // Update buttons
      tabBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Update content
      tabContents.forEach(content => {
        content.classList.remove('active');
        if (content.id === `${targetTab}-tab`) {
          content.classList.add('active');
        }
      });
    });
  });
  
  // SETTINGS CONFIRMATION MODAL
  const openBtn = document.getElementById("openConfirmModal");
  const confirmModal = new bootstrap.Modal(document.getElementById("confirmModal"));
  const confirmBtn = document.getElementById("confirmSaveBtn");
  const settingsForm = document.getElementById("settingsForm");
  
  if (openBtn) {
    openBtn.addEventListener("click", () => confirmModal.show());
  }
  
  if (confirmBtn) {
    confirmBtn.addEventListener("click", () => {
      confirmModal.hide();
      settingsForm.submit();
    });
  }
  
  // ROUTE CHART
  const chartLabels = JSON.parse('{{ chart_labels|escapejs }}');
  const chartData = JSON.parse('{{ chart_data|escapejs }}');
  
  const ctx = document.getElementById('routesChart');
  if (ctx) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [{
          data: chartData,
          backgroundColor: 'rgba(37,99,235,.8)',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
  
  // EDIT ROUTE MODAL
  const editBtns = document.querySelectorAll('.btn-edit');
  const editModal = new bootstrap.Modal(document.getElementById('editRouteModal'));
  
  editBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      document.getElementById('editRouteId').value = this.dataset.id;
      document.getElementById('editOrigin').value = this.dataset.origin;
      document.getElementById('editDestination').value = this.dataset.destination;
      document.getElementById('editFare').value = this.dataset.fare;
      document.getElementById('editActive').checked = this.dataset.active === "True";
      editModal.show();
    });
  });
  
});
</script>

{% endblock %}
