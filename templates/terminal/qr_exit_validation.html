{% extends "base.html" %}
{% load static %}

{% block title %}QR Exit Validation | RDFS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/terminal/qr-exit.css' %}?v=1.0">
{% endblock %}

{% block content %}

<div class="qr-exit-container">

  <!-- HEADER -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="bi bi-box-arrow-right"></i>
        QR Exit Validation Scanner
      </h1>
      <p class="page-subtitle">
        Scan vehicle QR codes to confirm terminal departure and mark as exited
      </p>
    </div>
    <a href="{% if user.role == 'admin' %}{% url 'accounts:admin_dashboard' %}{% else %}{% url 'accounts:staff_dashboard' %}{% endif %}"
       class="btn-back">
      <i class="bi bi-arrow-left-circle"></i>
      Dashboard
    </a>
  </div>

  <!-- INFO ALERT -->
  <div class="info-alert">
    <div class="info-alert-icon">
      <i class="bi bi-shield-check"></i>
    </div>
    <div class="info-alert-content">
      <h3 class="info-alert-title">Exit Validation Process</h3>
      <p class="info-alert-text">
        Scan a vehicle's QR code to mark it as <strong>departed</strong>. 
        The system automatically validates if the vehicle is currently inside the terminal.
      </p>
    </div>
  </div>

  <!-- STATUS LEGEND -->
  <div class="status-legend">
    <div class="legend-title">
      <i class="bi bi-info-circle"></i>
      Exit Status Indicators
    </div>
    <div class="legend-items">
      <div class="legend-item">
        <span class="legend-badge badge-success">
          <i class="bi bi-check-circle-fill"></i>
          Departed
        </span>
        <span class="legend-text">Vehicle successfully exited</span>
      </div>
      <div class="legend-item">
        <span class="legend-badge badge-error">
          <i class="bi bi-x-circle-fill"></i>
          Invalid
        </span>
        <span class="legend-text">Vehicle not in terminal or invalid QR</span>
      </div>
      <div class="legend-item">
        <span class="legend-badge badge-warning">
          <i class="bi bi-exclamation-triangle-fill"></i>
          Error
        </span>
        <span class="legend-text">System error or network issue</span>
      </div>
    </div>
  </div>

  <!-- MAIN SCANNER CARD -->
  <div class="scanner-card">
    <div class="scanner-card-header">
      <div class="scanner-header-content">
        <i class="bi bi-camera-video"></i>
        <div>
          <h2 class="scanner-title">Exit QR Scanner</h2>
          <p class="scanner-subtitle">Position vehicle QR code within the frame</p>
        </div>
      </div>
      <div class="scanner-status" id="scannerStatus">
        <span class="status-dot"></span>
        <span class="status-text">Ready</span>
      </div>
    </div>

    <div class="scanner-card-body">

      <!-- START CAMERA SECTION -->
      <div id="startCameraSection" class="start-camera-section">
        <div class="camera-icon-large">
          <i class="bi bi-camera-fill"></i>
        </div>
        <h3 class="start-camera-title">Activate Camera to Begin</h3>
        <p class="start-camera-text">
          Click the button below to start the exit validation scanner
        </p>
        <button id="startCameraBtn" class="btn-start-camera">
          <i class="bi bi-camera-video-fill"></i>
          Start Camera
        </button>
      </div>

      <!-- QR SCANNER -->
      <div id="qrScannerWrap" class="qr-scanner-wrap">
        <div id="rdfsQrReader" class="qr-reader"></div>
      </div>

      <!-- FEEDBACK AREA -->
      <div id="feedbackArea" class="feedback-area">
        <!-- Status messages will appear here -->
      </div>

      <!-- QUICK ACTIONS -->
      <div class="quick-actions">
        <a href="{% url 'terminal:terminal_queue' %}" class="btn-quick-action">
          <i class="bi bi-list-check"></i>
          View Terminal Queue
        </a>
      </div>

    </div>
  </div>

  <!-- CSRF -->
  <form style="display:none;">{% csrf_token %}</form>

</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="{% static 'js/terminal/qr-exit.js' %}?v=1.0"></script>

{% endblock %}
