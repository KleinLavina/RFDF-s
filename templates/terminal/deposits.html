{% extends 'base.html' %}
{% load static %}
{% block title %}Deposit Management | RDFS{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'styles/terminal/deposits.css' %}">

<div class="deposits-page">

  <!-- PAGE HEADER -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-wallet me-2"></i>
        Deposit Management
      </h1>
      <p class="page-subtitle">
        <i class="fas fa-info-circle me-1"></i>
        Manage driver wallet deposits and view transaction history
      </p>
    </div>

    {% if user.role == 'admin' %}
      <a href="{% url 'accounts:admin_dashboard' %}" class="btn-back">
        <i class="fas fa-arrow-left me-2"></i>
        Back to Dashboard
      </a>
    {% else %}
      <a href="{% url 'accounts:staff_dashboard' %}" class="btn-back">
        <i class="fas fa-arrow-left me-2"></i>
        Back to Dashboard
      </a>
    {% endif %}
  </div>

  <!-- FLASH MESSAGES -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- TABS NAVIGATION -->
  <div class="tabs-container">
    <button class="tab-btn active" data-tab="wallets">
      <i class="fas fa-wallet me-2"></i>
      Driver Wallets
    </button>
    <button class="tab-btn" data-tab="history">
      <i class="fas fa-history me-2"></i>
      Deposit History
    </button>
  </div>

  <!-- TAB CONTENT: WALLETS -->
  <div class="tab-content active" id="wallets-tab">
    
    <!-- INFO BANNER -->
    <div class="info-banner">
      <div class="banner-content">
        <i class="fas fa-coins me-2"></i>
        <strong>Minimum Required Balance:</strong>
        <span class="fee-amount">₱{{ min_deposit }}</span>
      </div>
      <button type="button" class="btn-add-deposit" data-bs-toggle="modal" data-bs-target="#addDepositModal">
        <i class="fas fa-plus-circle me-2"></i>
        Add Deposit
      </button>
    </div>

    <!-- STATS GRID -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon wallets-icon">
          <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ wallets_total }}</div>
          <div class="stat-label">Total Wallets</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon balance-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">₱{{ total_balance|floatformat:2 }}</div>
          <div class="stat-label">Total Balance</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon low-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ low_balance_count }}</div>
          <div class="stat-label">Low Balance</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon deposits-icon">
          <i class="fas fa-receipt"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ total_deposits }}</div>
          <div class="stat-label">Total Deposits</div>
        </div>
      </div>
    </div>

    <!-- SEARCH & FILTER -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-search me-2"></i>
        Search & Filter
      </h2>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-magnifying-glass me-1"></i>
            Live Search
          </label>
          <input type="text"
                 id="liveSearchInput"
                 class="form-control"
                 placeholder="Driver name, license, or plate..."
                 value="{{ wallet_search }}">
          <small class="form-hint">Search updates automatically as you type</small>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-sort me-1"></i>
            Sort By
          </label>
          <select id="liveSortSelect" class="form-select">
            <option value="newest" {% if wallet_sort == 'newest' %}selected{% endif %}>Newest Deposits</option>
            <option value="largest" {% if wallet_sort == 'largest' %}selected{% endif %}>Largest Balance</option>
            <option value="smallest" {% if wallet_sort == 'smallest' %}selected{% endif %}>Smallest Balance</option>
            <option value="driver_asc" {% if wallet_sort == 'driver_asc' %}selected{% endif %}>Driver A → Z</option>
            <option value="driver_desc" {% if wallet_sort == 'driver_desc' %}selected{% endif %}>Driver Z → A</option>
          </select>
        </div>
      </div>

      <div class="search-status">
        <span id="visibleCount">{{ wallets|length }}</span> of <span id="totalCount">{{ wallets_total }}</span> wallets
        <div class="loading-indicator" id="loadingIndicator">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Searching...</span>
        </div>
      </div>
    </div>

    <!-- WALLETS TABLE -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-list me-2"></i>
        Driver Wallets
      </h2>

      <div class="table-container">
        <table class="wallets-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Driver</th>
              <th>License Plate</th>
              <th>Current Balance</th>
              <th>Last Deposit</th>
              <th>Last Deposit Date</th>
              <th>Total Deposits</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="walletsTableBody">
            {% if wallets %}
              {% for wallet in wallets %}
                <tr data-driver="{{ wallet.vehicle.assigned_driver.first_name|lower }} {{ wallet.vehicle.assigned_driver.last_name|lower }}"
                    data-plate="{{ wallet.vehicle.license_plate|lower }}"
                    data-license="{{ wallet.vehicle.assigned_driver.license_number|lower|default:'' }}"
                    data-balance="{{ wallet.balance }}"
                    data-date="{{ wallet.last_deposit_at|date:'Y-m-d H:i:s'|default:'0000-00-00' }}">
                  <td class="row-number">{{ forloop.counter }}</td>
                  <td class="fw-semibold">
                    {{ wallet.vehicle.assigned_driver.first_name }} {{ wallet.vehicle.assigned_driver.last_name }}
                  </td>
                  <td>
                    <span class="plate-badge">{{ wallet.vehicle.license_plate }}</span>
                  </td>
                  <td>
                    {% if wallet.balance >= 500 %}
                      <span class="balance-badge high">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% elif wallet.balance >= 200 %}
                      <span class="balance-badge medium">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% elif wallet.balance >= min_deposit %}
                      <span class="balance-badge low">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% else %}
                      <span class="balance-badge critical">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% endif %}
                  </td>
                  <td>₱{{ wallet.last_deposit_amount|default:"0.00"|floatformat:2 }}</td>
                  <td>
                    {% if wallet.last_deposit_at %}
                      {{ wallet.last_deposit_at|date:"M d, Y h:i A" }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="count-badge">{{ wallet.deposit_count }}</span>
                  </td>
                  <td class="text-center">
                    <button type="button"
                            class="btn-action btn-deposit"
                            data-vehicle="{{ wallet.vehicle.id }}"
                            data-display="{{ wallet.vehicle.assigned_driver.first_name }} {{ wallet.vehicle.assigned_driver.last_name }} · {{ wallet.vehicle.license_plate }}">
                      <i class="fas fa-plus"></i>
                    </button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr id="emptyRow">
                <td colspan="8" class="text-center text-muted py-4">
                  <i class="fas fa-inbox fs-1 d-block mb-2 opacity-50"></i>
                  No wallets found
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB CONTENT: HISTORY -->
  <div class="tab-content" id="history-tab">
    
    <!-- HISTORY STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon history-icon">
          <i class="fas fa-receipt"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ history_count }}</div>
          <div class="stat-label">Total Records</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon amount-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">₱{{ history_total|floatformat:2 }}</div>
          <div class="stat-label">Total Amount</div>
        </div>
      </div>
    </div>

    <!-- HISTORY SEARCH & FILTER -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-filter me-2"></i>
        Filter History
      </h2>

      <form method="GET" class="form-grid">
        <input type="hidden" name="tab" value="history">
        
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-search me-1"></i>
            Search
          </label>
          <input type="text"
                 name="history_query"
                 value="{{ history_query }}"
                 class="form-control"
                 placeholder="Driver name, license, or plate...">
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-sort me-1"></i>
            Sort By
          </label>
          <select name="history_sort" class="form-select">
            <option value="newest" {% if history_sort == 'newest' %}selected{% endif %}>Newest First</option>
            <option value="largest" {% if history_sort == 'largest' %}selected{% endif %}>Largest Amount</option>
            <option value="smallest" {% if history_sort == 'smallest' %}selected{% endif %}>Smallest Amount</option>
            <option value="driver_asc" {% if history_sort == 'driver_asc' %}selected{% endif %}>Driver A → Z</option>
            <option value="driver_desc" {% if history_sort == 'driver_desc' %}selected{% endif %}>Driver Z → A</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-filter">
            <i class="fas fa-check-circle me-2"></i>
            Apply Filters
          </button>
        </div>
      </form>
    </div>

    <!-- HISTORY TABLE -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-clock-rotate-left me-2"></i>
        Deposit Records
      </h2>

      <div class="table-container">
        <table class="history-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Reference</th>
              <th>Driver</th>
              <th>Vehicle</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date & Time</th>
            </tr>
          </thead>
          <tbody>
            {% for deposit in history_deposits %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td><code class="ref-code">{{ deposit.reference_number }}</code></td>
                <td class="fw-semibold">
                  {{ deposit.wallet.vehicle.assigned_driver.first_name }}
                  {{ deposit.wallet.vehicle.assigned_driver.last_name }}
                </td>
                <td>
                  <span class="plate-badge">{{ deposit.wallet.vehicle.license_plate }}</span>
                </td>
                <td>
                  <span class="amount-badge">₱{{ deposit.amount|floatformat:2 }}</span>
                </td>
                <td>
                  <span class="status-badge status-{{ deposit.status|lower }}">
                    {{ deposit.status|capfirst }}
                  </span>
                </td>
                <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  <i class="fas fa-inbox fs-1 d-block mb-2 opacity-50"></i>
                  No deposit records found
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- ADD DEPOSIT MODAL -->
<div class="modal fade" id="addDepositModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-hand-holding-dollar me-2"></i>
          Add Deposit
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" id="addDepositForm">
          {% csrf_token %}
          <input type="hidden" name="vehicle_id" id="vehicleId">

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-user me-1"></i>
              Select Driver / Vehicle
            </label>
            <div class="search-wrapper">
              <input type="text"
                     id="driverSearch"
                     class="form-control"
                     placeholder="Search by name, license, or plate..."
                     autocomplete="off">
              <div id="driverSuggestions" class="suggestions-dropdown"></div>
            </div>
            <small class="form-hint">Start typing to search for a driver</small>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-money-bill-wave me-1"></i>
              Deposit Amount (₱)
            </label>
            <input type="number"
                   name="amount"
                   id="depositAmount"
                   min="1"
                   step="0.01"
                   class="form-control form-control-lg"
                   placeholder="0.00"
                   required>
            <small class="form-hint">Enter amount to deposit</small>
          </div>

          <div class="selected-info" id="selectedInfo">
            <div class="info-icon">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="info-content">
              <div id="selectedLabel" class="info-label">Select a driver to proceed</div>
              <div id="walletInfo" class="info-value"></div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="submit" class="btn-primary" id="submitDepositBtn" disabled>
              <i class="fas fa-check-circle me-2"></i>
              Confirm Deposit
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script>
const driverOptions = {{ driver_options|safe }};
</script>
<script src="{% static 'js/terminal/deposits.js' %}"></script>

{% endblock %}
