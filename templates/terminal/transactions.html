{% extends "base.html" %}
{% load static tz %}

{% block title %}Transactions & Queue Activity | RDFS{% endblock %}

{% block content %}

<style>
.rdfs-history-scope {
  font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
  color: #0f172a;
}
.rdfs-history-header h3 {
  font-weight: 700;
  color: #112666;
}
.rdfs-history-header p {
  color: #64748b;
}
.rdfs-history-card {
  border-radius: 16px;
  box-shadow: 0 12px 26px rgba(15, 23, 42, 0.08);
}
.rdfs-history-table thead th {
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.08em;
  border-bottom: 1px solid #e2e8f0;
}
.rdfs-history-table tbody tr td {
  padding: 0.85rem 0.75rem;
}
.rdfs-history-export select {
  min-width: 180px;
}
</style>

<div class="p-4 rdfs-history-scope">
  <div class="rdfs-history-header mb-4">
    <div>
      <h3 class="mb-1">
        <i class="bi bi-clock-history me-2"></i>
        Transactions & Queue Activity
      </h3>
      <p class="mb-0 small">
        Unified view of fee deductions, queue events, and historical wallet snapshots.
      </p>
    </div>
  </div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card border-0 rdfs-history-card">
        <div class="card-body text-center">
          <p class="text-muted small mb-1">System revenue</p>
          <h4 class="text-success mb-0">₱{{ total_revenue|floatformat:2 }}</h4>
          <p class="small text-muted mb-0">Success entries: {{ total_success }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 rdfs-history-card">
        <div class="card-body text-center">
          <p class="text-muted small mb-1">Vehicles currently queued</p>
          <h4 class="text-primary mb-0">{{ active_queue }}</h4>
          <p class="small text-muted mb-0">Active entry logs</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 rdfs-history-card">
        <div class="card-body text-center">
          <p class="text-muted small mb-1">Queue events</p>
          <h4 class="text-warning mb-0">{{ queue_events }}</h4>
          <p class="small text-muted mb-0">Snapshot records captured</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 rdfs-history-card">
        <div class="card-body text-center">
          <p class="text-muted small mb-1">Records shown</p>
          <h4 class="text-info mb-0">{{ activity_count }}</h4>
          <p class="small text-muted mb-0">Latest combined entries</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 rdfs-history-card">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <div class="small text-muted">Most recent activity first (entries and queue history).</div>
        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#csvExportModal">
          <i class="bi bi-file-earmark-spreadsheet-fill me-1"></i>
          Export CSV
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-hover table-borderless rdfs-history-table mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Driver</th>
              <th>Plate</th>
              <th>Wallet deduction</th>
              <th>System revenue</th>
              <th>Wallet balance</th>
            </tr>
          </thead>
          <tbody>
            {% if activity %}
              {% for entry in activity %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ entry.timestamp|localtime|date:"M d, Y h:i A" }}</td>
                  <td>
                    {{ entry.driver }}
                    {% if entry.source == "Queue History" %}
                      <span class="badge bg-warning text-dark ms-1 small">Queue event</span>
                    {% endif %}
                  </td>
                  <td>
                    {{ entry.plate }}
                  </td>
                  <td class="text-danger fw-semibold">
                    {% if entry.fee is not None %}
                      -₱{{ entry.fee|floatformat:2 }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td class="text-success fw-semibold">
                    {% if entry.fee is not None %}
                      ₱{{ entry.fee|floatformat:2 }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    {% if entry.balance is not None %}
                      ₱{{ entry.balance|floatformat:2 }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  No activity yet.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="csvExportModal" tabindex="-1" aria-labelledby="csvExportModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="get" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="csvExportModalLabel">Export CSV</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="small text-muted">
          Choose the range you want to export. Select a year, month, week, or define a custom date window.
        </p>
        <div class="mb-3">
          <label class="form-label small mb-1">Range type</label>
          <select id="exportRangeType" name="range_type" class="form-select form-select-sm">
            <option value="">All history</option>
            <option value="year" {% if range_type == "year" %}selected{% endif %}>Year</option>
            <option value="month" {% if range_type == "month" %}selected{% endif %}>Month</option>
            <option value="week" {% if range_type == "week" %}selected{% endif %}>Week</option>
            <option value="custom" {% if range_type == "custom" %}selected{% endif %}>Custom</option>
          </select>
        </div>
        <div class="mb-3 range-input d-none" data-range="year">
          <label class="form-label small mb-1">Year</label>
          <input type="number" min="2000" max="2100" name="export_year" class="form-control form-control-sm" value="{{ export_year }}">
        </div>
        <div class="mb-3 range-input d-none" data-range="month">
          <label class="form-label small mb-1">Month</label>
          <input type="month" name="export_month" class="form-control form-control-sm" value="{{ export_month }}">
        </div>
        <div class="mb-3 range-input d-none" data-range="week">
          <label class="form-label small mb-1">Week</label>
          <input type="week" name="export_week" class="form-control form-control-sm" value="{{ export_week }}">
        </div>
        <div class="range-input d-none" data-range="custom">
          <label class="form-label small mb-1">Start date</label>
          <input type="date" name="export_start" class="form-control form-control-sm mb-2" value="{{ export_start }}">
          <label class="form-label small mb-1">End date</label>
          <input type="date" name="export_end" class="form-control form-control-sm" value="{{ export_end }}">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" name="export" value="csv" class="btn btn-success btn-sm">
          Download CSV
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const select = document.getElementById("exportRangeType");
  const groups = document.querySelectorAll(".range-input");
  function updateGroups() {
    const value = select.value;
    groups.forEach(el => {
      el.classList.toggle("d-none", el.dataset.range !== value);
    });
  }
  if (select) {
    select.addEventListener("change", updateGroups);
    updateGroups();
  }
});
</script>

{% endblock %}
